#!/usr/bin/env python3# -*- coding: utf-8 -*-"""unified_config_service.py 核心函数测试提升覆盖率从 29.3% 到 60%+"""import pytestimport osimport jsonimport tempfilefrom pathlib import Pathfrom datetime import datetime, timezone, timedelta, timedeltafrom unittest.mock import Mock, patch, MagicMock, mock_openfrom app.core.unified_config_service import (    UnifiedConfigManager,    get_config_manager,    ConfigCacheEntry,)class TestConfigCacheEntry:    """测试配置缓存条目"""    def test_creation_with_datetime(self):        """测试使用 datetime 创建缓存条目"""        entry = ConfigCacheEntry(            value="test_value",            timestamp=datetime.now(timezone.utc),            ttl=60,            source="env",        )        assert entry.value == "test_value"        assert entry.ttl == 60        assert entry.source == "env"    def test_expired_entry(self):        """测试过期的缓存条目"""        old_time = datetime.now(timezone.utc) - timedelta(seconds=120)        entry = ConfigCacheEntry(            value="test_value", timestamp=old_time, ttl=60, source="env"        )        assert entry.is_expired() is True    def test_not_expired_entry(self):        """测试未过期的缓存条目"""        recent_time = datetime.now(timezone.utc) - timedelta(seconds=30)        entry = ConfigCacheEntry(            value="test_value", timestamp=recent_time, ttl=60, source="env"        )        assert entry.is_expired() is False    def test_zero_ttl_always_expired(self):        """测试 TTL 为 0 时总是过期"""        entry = ConfigCacheEntry(            value="test_value",            timestamp=datetime.now(timezone.utc),            ttl=0,            source="env",        )        assert entry.is_expired() is Trueclass TestUnifiedConfigManagerGetModelConfig:    """测试模型配置获取"""    @patch("app.core.unified_config_service.get_mongo_db_sync")    @patch("app.core.unified_config_service.get_config_manager")    def test_get_model_config_default(self, mock_get_config, mock_get_db):        """测试获取不存在的模型配置（返回默认值）"""        mock_db.return_value = None        mock_config = Mock()        mock_get_config.return_value = mock_config        manager = UnifiedConfigManager()        config = manager.get_model_config("nonexistent_model")        assert config["model_name"] == "nonexistent_model"        assert config["provider"] == "dashscope"        assert config["max_tokens"] == 4000    @patch("app.core.unified_config_service.get_mongo_db_sync")    @patch("app.core.unified_config_service.get_config_manager")    def test_get_model_config_from_mongodb(self, mock_get_db, mock_get_config):        """测试从 MongoDB 获取模型配置"""        mock_db = Mock()        mock_config_doc = {            "is_active": True,            "llm_configs": [                {                    "model_name": "gpt-4",                    "max_tokens": 8000,                    "temperature": 0.8,                    "provider": "openai",                    "api_base": "https://api.openai.com",                    "input_price_per_1k": 0.03,                    "output_price_per_1k": 0.06,                }            ],        }        mock_db.__getitem__ = Mock(return_value=mock_db)        mock_db.__getitem__.return_value.find_one.return_value = mock_config_doc        mock_get_db.return_value = mock_db        mock_get_config.return_value = mock_config        manager = UnifiedConfigManager()        config = manager.get_model_config("gpt-4")        assert config["model_name"] == "gpt-4"        assert config["max_tokens"] == 8000        assert config["temperature"] == 0.8        assert config["provider"] == "openai"    @patch.dict(os.environ, {"DEEPSEEK_API_KEY": "test-key"})    @patch("app.core.unified_config_service.get_mongo_db_sync")    @patch("app.core.unified_config_service.get_config_manager")    def test_get_provider_inference_from_model_name(self, mock_get_db, mock_get_config):        """测试从模型名称推断 provider"""        mock_db.return_value = None        mock_get_config.return_value = Mock()        manager = UnifiedConfigManager()        # gpt 模型        assert manager.get_provider_by_model("gpt-4") == "openai"        assert manager.get_provider_by_model("gpt-3.5-turbo") == "openai"        # gemini 模型        assert manager.get_provider_by_model("gemini-pro") == "google"        # deepseek 模型        assert manager.get_provider_by_model("deepseek-chat") == "deepseek"        # 默认模型        assert manager.get_provider_by_model("unknown-model") == "dashscope"class TestUnifiedConfigManagerSystemSettings:    """测试系统设置"""    @patch("app.core.unified_config_service.get_mongo_db_sync")    @patch("app.core.unified_config_service.get_config_manager")    def test_get_system_setting_from_env(self, mock_get_db, mock_get_config):        """测试从环境变量获取系统设置"""        mock_get_db.return_value = None        mock_get_config.return_value.get.return_value = "env_value"        manager = UnifiedConfigManager()        result = manager.get_system_setting("test_key", default="default_value")        assert result == "env_value"    @patch("app.core.unified_config_service.get_mongo_db_sync")    @patch("app.core.unified_config_service.get_config_manager")    def test_get_system_setting_from_mongodb(self, mock_get_db, mock_config):        """测试从 MongoDB 获取系统设置"""        mock_config_doc = {            "is_active": True,            "system_settings": {"test_key": "mongo_value", "test_key2": "mongo_value2"},        }        mock_db = Mock()        mock_db.__getitem__ = Mock(return_value=mock_db)        mock_db.__getitem__.return_value.find_one.return_value = mock_config_doc        mock_get_db.return_value = mock_db        mock_get_config.get.return_value.get.return_value = None        manager = UnifiedConfigManager()        result = manager.get_system_setting("test_key")        assert result == "mongo_value"    @patch("app.core.unified_config_service.get_mongo_db_sync")    @patch("app.core.unified_config_service.get_config_manager")    def test_get_quick_analysis_model_from_settings(self, mock_get_db, mock_config):        """测试从系统设置获取快速分析模型"""        mock_config_doc = {            "is_active": True,            "system_settings": {                "quick_analysis_model": "gpt-3.5-turbo",                "deep_analysis_model": "gpt-4-turbo",            },        }        mock_db = Mock()        mock_db.__getitem__ = Mock(return_value=mock_config_doc)        mock_db.__getitem__.return_value.find_one.return_value = mock_config_doc        mock_get_db.return_value = mock_db        mock_get_config.get.return_value.get.return_value = "mongo_value"        manager = UnifiedConfigManager()        model = manager.get_quick_analysis_model()        assert model == "gpt-3.5-turbo"    @patch("app.core.unified_config_service.get_mongo_db_sync")    @patch("app.core.unified_config_service.get_config_manager")    def test_get_deep_analysis_model_from_settings(self, mock_get_db, mock_config):        """测试从系统设置获取深度分析模型"""        mock_config_doc = {            "is_active": True,            "system_settings": {                "quick_analysis_model": "gpt-3.5-turbo",                "deep_analysis_model": "gpt-4-turbo",            },        }        mock_db = Mock()        mock_db.__getitem__ = Mock(return_value=mock_config_doc)        mock_db.__getitem__.return_value.find_one.return_value = mock_config_doc        mock_get_db.return_value = mock_db        mock_get_config.get.return_value.get.return_value = "mongo_value"        manager = UnifiedConfigManager()        model = manager.get_deep_analysis_model()        assert model == "gpt-4-turbo"class TestUnifiedConfigManagerCacheManagement:    """测试缓存管理"""    def test_clear_all_cache(self):        """测试清除所有缓存"""        manager = UnifiedConfigManager()        # 添加一些缓存        manager._cache["test_key"] = ConfigCacheEntry(            value="test", timestamp=datetime.now(timezone.utc), ttl=60, source="env"        )        manager.clear_cache()        assert len(manager._cache) == 0    def test_clear_cache_with_pattern(self):        """测试按模式清除缓存"""        manager = UnifiedConfigManager()        # 添加多个缓存        manager._cache["general:test_key"] = ConfigCacheEntry(            value="test1", timestamp=datetime.now(timezone.utc), ttl=60, source="env"        )        manager._cache["llm:test_key"] = ConfigCacheEntry(            value="test2",            timestamp=datetime.now(timezone.utc),            ttl=60,            source="mongodb",        )        manager.clear_cache(pattern="llm:")        assert len(manager._cache) == 1        assert "general:test_key" in manager._cache        assert "llm:test_key" not in manager._cache    def test_refresh_db_config(self):        """测试刷新 MongoDB 配置缓存"""        manager = UnifiedConfigManager()        manager._db_config_cache = {"test": "cached"}        manager._db_config_cache_timestamp = datetime.now(timezone.utc)        manager.refresh_db_config()        assert manager._db_config_cache is None        assert manager._db_config_cache_timestamp is None    def test_get_cache_stats(self):        """测试获取缓存统计"""        manager = UnifiedConfigManager()        # 添加一些缓存        manager._cache["test1"] = ConfigCacheEntry(            value="test1", timestamp=datetime.now(timezone.utc), ttl=60, source="env"        )        manager._cache["test2"] = ConfigCacheEntry(            value="test2",            timestamp=datetime.now(timezone.utc) - timedelta(seconds=120),            ttl=60,            source="mongodb",        )        stats = manager.get_cache_stats()        assert stats["total_entries"] == 2        assert stats["expired_entries"] == 1        assert stats["sources"]["env"] == 1        assert stats["sources"]["mongodb"] == 1        assert stats["db_config_cached"] is Falseif __name__ == "__main__":    pytest.main([__file__, "-v"])