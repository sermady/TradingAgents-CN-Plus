# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working on TradingAgents-CN.

## Quick Links

- **å®Œæ•´å¼€å‘è§„èŒƒ**: [SKILLS.md](./skills/SKILLS.md)
- **README**: [README.md](./README.md)
- **pytesté…ç½®**: [pytest.ini](./pytest.ini)

## Core Rules

### 1. Always use Chinese
**æ³¨æ„**: è¯·ä½¿ç”¨ä¸­æ–‡å›ç­”ç”¨æˆ·çš„æ‰€æœ‰é—®é¢˜å’Œäº¤æµã€‚

### 2. File Creation Rules
See **skills/SKILLS.md > Section 2** for complete file location and naming rules.

### 3. Encoding Standards
See **skills/SKILLS.md > Section 3** for encoding requirements.

### 4. Testing Standards
See **skills/SKILLS.md > Section 4** for testing patterns and pytest markers.

### 5. Data Sources
See **skills/SKILLS.md > Section 5** for data source development guidelines.

### 6. Git Conventions
See **skills/SKILLS.md > Section 6** for commit message format.

## Development Commands

```bash
# Backend (FastAPI)
python -m app

# Frontend (Vue 3)
cd frontend && npm run dev

# Docker Deployment
scripts\docker\start_docker_services.bat

# Run Tests
python -m pytest tests/unit/ -v

# Data Import
python scripts/import/import_a_stocks_unified.py --data-source baostock
```

## Architecture Overview

TradingAgents-CN = FastAPI + Vue 3 + MongoDB/Redis + LangGraph Multi-Agent System

**Data Sources**: Tushare â†’ Baostock â†’ AkShare (auto-fallback)

**Multi-Agent System**:
- Analysts: Market, News, Social, Fundamentals, China
- Researchers: Bull/Bear (debate mechanism)
- Risk Management: Aggressive/Conservative/Neutral
- Trader: Final trading decision

See **skills/SKILLS.md > Section 1** for detailed architecture diagrams.

## License Information

| Component | License | Commercial Use |
|-----------|---------|----------------|
| `tradingagents/` | Apache 2.0 | Free with attribution |
| `app/` | Proprietary | Contact: hsliup@163.com |
| `frontend/` | Proprietary | Contact: hsliup@163.com |

**Personal/Learning Use**: All functionality can be used freely.

## Known Issues & Debugging Guide

### ğŸŸ¢ Tushare æ¯å°æ—¶æ‰¹é‡å®æ—¶è¡Œæƒ…åŒæ­¥ (2026-01-30)

**åŠŸèƒ½**: ä½¿ç”¨ Tushare `rt_k` æ¥å£æ¯å°æ—¶æ‰¹é‡åŒæ­¥å…¨å¸‚åœºå®æ—¶è¡Œæƒ…ï¼ˆçº¦ 5000+ åªè‚¡ç¥¨ï¼‰

**å®ç°æ–‡ä»¶**:
- `app/core/config.py` - æ–°å¢é…ç½®é¡¹
- `app/worker/tushare_sync_service.py` - æ–°å¢ `run_tushare_hourly_bulk_sync()` å‡½æ•°
- `app/main.py` - è°ƒåº¦å™¨é…ç½®

**é…ç½®è¯´æ˜**:
```python
# .env æ–‡ä»¶æˆ–é…ç½®ä¸­å¿ƒ
TUSHARE_HOURLY_BULK_SYNC_ENABLED=true  # å¯ç”¨æ¯å°æ—¶æ‰¹é‡åŒæ­¥
TUSHARE_HOURLY_BULK_SYNC_CRON="0 9-15 * * 1-5"  # å·¥ä½œæ—¥9-15ç‚¹æ¯å°æ—¶æ‰§è¡Œ
```

**æ•°æ®å­˜å‚¨**:
- **MongoDB**: `market_quotes` é›†åˆï¼ŒæŒä¹…åŒ–å­˜å‚¨
- **Redis**: `realtime_quote:{symbol}` keyï¼Œç¼“å­˜10åˆ†é’Ÿ

**æ‰§è¡Œé€»è¾‘**:
1. æ£€æŸ¥æ˜¯å¦åœ¨äº¤æ˜“æ—¶æ®µï¼ˆå·¥ä½œæ—¥ 9:30-15:30ï¼‰
2. ä½¿ç”¨ `rt_k` æ¥å£ä¸€æ¬¡æ€§è·å–å…¨å¸‚åœºæ•°æ®
3. æ‰¹é‡å†™å…¥ MongoDB å’Œ Redis
4. æ¯å°æ—¶æ•´ç‚¹è§¦å‘ï¼ˆå¦‚ 10:00, 11:00...ï¼‰

**é€‚ç”¨åœºæ™¯**:
- æœ‰è¶³å¤Ÿ Tushare ç§¯åˆ†ï¼ˆrt_k æ¥å£éœ€è¦ç§¯åˆ†ï¼‰
- éœ€è¦å…¨å¸‚åœºå®æ—¶è¡Œæƒ…æ•°æ®
- æ›¿ä»£åŸæœ‰çš„é«˜é¢‘å®æ—¶è¡Œæƒ…åŒæ­¥

---

### ğŸŸ¢ å®æ—¶è¡Œæƒ…æ•°æ®æºåˆ†ç¦» (2026-01-29)

**ä¿®æ”¹ç›®æ ‡**: åˆ†æè‚¡ç¥¨æ—¶ä¼˜å…ˆä» MongoDB è¯»å–å†å²æ•°æ®ï¼Œå®æ—¶è¡Œæƒ…æ—¶ç›´æ¥è°ƒç”¨å¤–éƒ¨ API

**ä¿®æ”¹å†…å®¹**:
1. **`tradingagents/dataflows/data_source_manager.py:1441-1560`**
   - é‡æ„ `get_realtime_quote()` æ–¹æ³•ï¼Œç§»é™¤ MongoDB å¤‡é€‰é€»è¾‘
   - å®ç° `get_tushare_realtime_quote()` æ–¹æ³•ï¼Œä½¿ç”¨ Tushare Sina æ¥å£è·å–å®æ—¶è¡Œæƒ…
   - æ–°å¢ `_update_price_cache()` è¾…åŠ©æ–¹æ³•

**æ–°çš„æ•°æ®è·å–ç­–ç•¥**:
```
å†å²æ•°æ®: MongoDB â†’ Tushare â†’ AKShare â†’ BaoStock (ç¼“å­˜ä¼˜å…ˆ)
å®æ—¶è¡Œæƒ…: AKShare â†’ Tushare â†’ None (åªä½¿ç”¨å¤–éƒ¨API)
```

**å®æ—¶è¡Œæƒ…ä¼˜å…ˆçº§**:
1. **AKShare** (æ–°æµª/ä¸œæ–¹è´¢å¯Œ) - ç§’çº§å®æ—¶æ•°æ®ï¼Œä¼˜å…ˆå°è¯•
2. **Tushare** (æ–°æµªè´¢ç») - æ— éœ€é«˜çº§æƒé™ï¼Œè‡ªåŠ¨é™çº§
3. **None** - æ‰€æœ‰å¤–éƒ¨APIå¤±è´¥æ—¶è¿”å› Noneï¼Œä¸ä½¿ç”¨ MongoDB ç¼“å­˜

**æµ‹è¯•éªŒè¯**:
```bash
# éªŒè¯å®æ—¶è¡Œæƒ…åªä½¿ç”¨å¤–éƒ¨API
python test_realtime_quote.py
# é¢„æœŸè¾“å‡º: source: tushare_sina_realtime æˆ– source: sina_realtime
```

---

### ğŸŸ¢ æˆäº¤é‡å•ä½ç»Ÿä¸€ä¸º"æ‰‹" (2026-01-29)

**ä¿®æ”¹ç›®æ ‡**: å°† Tushare/AKShare/BaoStock çš„æˆäº¤é‡å•ä½ç»Ÿä¸€ä¸º"æ‰‹"(1æ‰‹=100è‚¡)

**èƒŒæ™¯é—®é¢˜**:
- Tushare/AKShare è¿”å›"æ‰‹"ï¼Œä½†ä»£ç è½¬æ¢ä¸º"è‚¡"
- BaoStock è¿”å›"è‚¡"ï¼Œä»£ç æœªè½¬æ¢
- å¯¼è‡´ MongoDB ä¸­æ··åˆæ ¼å¼ï¼ŒAI åˆ†ææ—¶æ•°å€¼æ··ä¹±

**ä¿®æ”¹å†…å®¹**:
1. **Tushare** (`tushare.py:1789-1791, 2530-2531`): ç§»é™¤ `* 100` è½¬æ¢ï¼Œä¿æŒ"æ‰‹"
2. **AKShare** (`akshare.py:944-946, 1277-1280`): ç§»é™¤ `* 100` è½¬æ¢ï¼Œä¿æŒ"æ‰‹"
3. **BaoStock** (`baostock.py`): 
   - æ·»åŠ  `/ 100` è½¬æ¢ï¼Œä»"è‚¡"è½¬ä¸º"æ‰‹"
   - æˆäº¤é¢ç¡®è®¤åŸå§‹å•ä½æ˜¯"å…ƒ"ï¼Œç§»é™¤é”™è¯¯è½¬æ¢
4. **App é€‚é…å™¨**: tushare_adapter.py, akshare_adapter.py åŒæ­¥ä¿®æ”¹

**æ•°æ®è¿ç§»æ­¥éª¤**:
```bash
# 1. æ¸…é™¤ MongoDB ä¸­çš„æ—§ volume æ•°æ®
python scripts/clear_volume_data.py

# 2. é‡æ–°å¯¼å…¥æ•°æ®
python scripts/import/import_a_stocks_unified.py --data-source tushare

# 3. éªŒè¯å•ä½
python scripts/test_volume_unit.py
```

**æˆäº¤é¢å•ä½ç¡®è®¤**:
- Tushare: åŸå§‹"åƒå…ƒ" â†’ è½¬æ¢ä¸º"å…ƒ" (Ã—1000) âœ…
- AKShare: åŸå§‹"å…ƒ" â†’ ç›´æ¥ä½¿ç”¨ âœ…  
- BaoStock: åŸå§‹"å…ƒ" â†’ ç›´æ¥ä½¿ç”¨ âœ…

---

### ğŸŸ¢ æ•°æ®è´¨é‡è¯„åˆ†éšè— (2026-01-29)

**ä¿®æ”¹ç›®æ ‡**: ä» AI æç¤ºè¯ä¸­ç§»é™¤æ•°æ®è´¨é‡è¯„åˆ†ï¼Œå‡å°‘å¹²æ‰°

**ä¿®æ”¹å†…å®¹**:
- `market_analyst.py`, `fundamentals_analyst.py`, `news_analyst.py`, `china_market_analyst.py`
- ä»æç¤ºè¯ä¸­ç§»é™¤ "æ•°æ®è´¨é‡è¯„åˆ†: 0%" ç­‰å†…å®¹
- ä¿ç•™æ•°æ®æ¥æºå’Œæˆäº¤é‡å•ä½ç­‰å¿…è¦å…ƒæ•°æ®
- æ•°æ®è´¨é‡é—®é¢˜ä»è®°å½•åˆ°æ—¥å¿— (`logger.warning`)

**åŸå› **: ç»å¸¸å‡ºç° 0% è¯„åˆ†åè€Œè®© AI è´¨ç–‘æ•°æ®å¯é æ€§

---

### ğŸ”´ åˆ†ææ—¥æœŸä¼ é€’ Bug (å·²ä¿®å¤)

**é—®é¢˜ç°è±¡**: åˆ†æå¸ˆä½¿ç”¨ç³»ç»Ÿæ—¶é—´è€Œéå‰ç«¯æŒ‡å®šçš„åˆ†ææ—¥æœŸï¼ˆå¦‚ 2024å¹´ vs 2026-01-29ï¼‰

**æ ¹æœ¬åŸå› **: æ—¥æœŸä¼ é€’é“¾æ–­è£‚
```
å‰ç«¯ â†’ propagate() â†’ state["trade_date"] âœ…
                     â†“
              Toolkit._config âŒ (æœªåŒæ­¥)
                     â†“
              å·¥å…·å‡½æ•° Fallback â†’ datetime.now()
```

**æ¶‰åŠæ–‡ä»¶**:
- `tradingagents/graph/trading_graph.py:988-993`
- `tradingagents/graph/propagation.py:30`

**ä¿®å¤æ–¹æ¡ˆ**: åœ¨ `propagate()` å¼€å¤´åŒæ­¥æ—¥æœŸåˆ°å…¨å±€é…ç½®
```python
from tradingagents.agents.utils.agent_utils import Toolkit
Toolkit._config["trade_date"] = str(trade_date)
Toolkit._config["analysis_date"] = str(trade_date)
```

**é¢„é˜²æªæ–½**:
1. æ‰€æœ‰æ¶‰åŠæ—¥æœŸçš„å·¥å…·å‡½æ•°ï¼Œä¼˜å…ˆä» `Toolkit._config` è·å–
2. Fallback é€»è¾‘åº”å…ˆæ£€æŸ¥ `Toolkit._config` å†ä½¿ç”¨ `datetime.now()`
3. æ–°å¢å·¥å…·æ—¶éœ€éªŒè¯æ—¥æœŸä¼ é€’é“¾å®Œæ•´æ€§

---

### ğŸŸ¢ Tushare ts_code æ ¼å¼ä¿®å¤ (2026-01-30)

**é—®é¢˜ç°è±¡**: Tushare è‚¡ç¥¨ä¿¡æ¯æŸ¥è¯¢æ—¶ ts_code æ ¼å¼é”™è¯¯ï¼Œå¯¼è‡´éƒ¨åˆ†æ¥å£è¿”å›ç©ºæ•°æ®

**ä¿®å¤å†…å®¹**:
- `tradingagents/dataflows/tushare.py`: ä¿®æ­£ ts_code æ ¼å¼å¤„ç†é€»è¾‘
- ç¡®ä¿è‚¡ç¥¨ä»£ç æ ¼å¼ç»Ÿä¸€ä¸º `000001.SZ` æ ¼å¼

**éªŒè¯æ–¹æ³•**:
```bash
# æµ‹è¯•Tushareè‚¡ç¥¨ä¿¡æ¯æŸ¥è¯¢
python -c "from tradingagents.dataflows import TushareProvider; t = TushareProvider(); print(t.get_stock_info('000001'))"
```

---

### ğŸŸ¢ LSP ç±»å‹é”™è¯¯ä¿®å¤ (2026-01-30)

**æ‰¹é‡ä¿®å¤å¤šä¸ªæ–‡ä»¶çš„ç±»å‹æ³¨è§£é—®é¢˜**:

1. **Tushare** (`tushare.py:132cf70`): ä¿®å¤ `Optional[str]` ç±»å‹é”™è¯¯
2. **AKShare** (`akshare.py:d71fbee`): ä¿®å¤ `Optional[str]` ç±»å‹é”™è¯¯
3. **BaoStock** (`baostock.py:cf16954`): ä¿®å¤ `Optional[str]` ç±»å‹é”™è¯¯
4. **Enum æ˜ å°„** (`1b3eff9`): ä¿®å¤ Enum æ˜ å°„å’Œ Optional å‚æ•°ç±»å‹é”™è¯¯

**ä¿®å¤åŸåˆ™**:
- æ˜ç¡®åŒºåˆ† `str` å’Œ `Optional[str]` çš„ä½¿ç”¨åœºæ™¯
- å‡½æ•°å‚æ•°é»˜è®¤å€¼ä¸º None æ—¶å¿…é¡»æ ‡æ³¨ `Optional[str]`
- è¿”å›å€¼å¯èƒ½ä¸º None æ—¶å¿…é¡»ä½¿ç”¨ `Optional[str]`

---

### ğŸŸ¢ æ•°æ®æºå¢å¼ºä¸ä¿®å¤æ‰¹æ¬¡ (2026-01-29)

**ç¬¬ä¸€æ‰¹ä¿®å¤** (`a9e62b4`): è§£å†³ DataFrame æ­§ä¹‰å’Œ tuple ç±»å‹é”™è¯¯
- ä¿®å¤ AKShare è¿”å›å€¼è§£åŒ…é—®é¢˜
- ç»Ÿä¸€è¿”å›æ•°æ®ç»“æ„

**ç¬¬äºŒæ‰¹ä¿®å¤** (`f62f69f`): Tushare å’Œ AKShare æ•°æ®æºå¢å¼º
- å¢åŠ é”™è¯¯é‡è¯•æœºåˆ¶
- ä¼˜åŒ–æ•°æ®ç¼“å­˜ç­–ç•¥

**ç¬¬ä¸‰æ‰¹ä¿®å¤** (`dd053ca`): BaoStock å¼‚æ­¥ + MongoDB å…œåº•
- æ·»åŠ å¼‚æ­¥è¿æ¥æ£€æŸ¥ï¼Œé¿å…é‡å¤ç™»å½•
- MongoDB ä½œä¸ºæ•°æ®è·å–å¤±è´¥æ—¶çš„å…œåº•æ–¹æ¡ˆ

---

### ğŸŸ¢ Tushare æ–°æ¥å£é›†æˆ (2026-01-29)

**æ–°å¢3ä¸ªæ¥å£ï¼Œå……åˆ†åˆ©ç”¨ 5210 ç§¯åˆ†æƒé™**:

1. **å®æ—¶è¡Œæƒ…æ¥å£** (`sina_realtime`): æ–°æµªè´¢ç»å®æ—¶æ•°æ®
2. **åˆ†é’Ÿçº¿æ•°æ®** (`minute_data`): æ”¯æŒ 1/5/15/30/60 åˆ†é’Ÿ K çº¿
3. **èµ„é‡‘æµå‘æ•°æ®** (`money_flow`): ä¸»åŠ›èµ„é‡‘æµå‘è¿½è¸ª

**æ¥å£ä¼˜å…ˆçº§**:
```
ç§¯åˆ†å……è¶³æ—¶: Tushare ä¼˜å…ˆ (ç¨³å®šæ€§é«˜)
ç§¯åˆ†ä¸è¶³æ—¶: AKShare å…œåº• (å…è´¹ä½†æœ‰é™æµ)
```

---

### ğŸ”´ æˆäº¤é‡å•ä½ä¿®å¤å®Œæ•´ç‰ˆ (2026-01-30)

**é—®é¢˜ç°è±¡**: åˆ†ææŠ¥å‘Šä¸­æˆäº¤é‡è¢«æ”¾å¤§äº†100å€

**æ ¹æœ¬åŸå› **: App å±‚ä»£ç ä¸æ•°æ®æºå±‚ä¸ä¸€è‡´

```
æ•°æ®æºå±‚ (tradingagents/dataflows/providers/china/*.py)
â”œâ”€â”€ å·²ä¿®å¤ï¼šç»Ÿä¸€è¿”å›"æ‰‹"å•ä½ âœ…
â””â”€â”€ ç§»é™¤äº† *100 è½¬æ¢

App å±‚ (app/services/*.py)
â”œâ”€â”€ æœªä¿®å¤ï¼šä»å°†"æ‰‹"Ã—100è½¬ä¸º"è‚¡"å­˜å…¥ MongoDB âŒ
â””â”€â”€ å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

ç»“æœ
â”œâ”€â”€ MongoDB å­˜å‚¨çš„æ˜¯"è‚¡"ï¼ˆé”™è¯¯ï¼‰
â””â”€â”€ æŠ¥å‘Šæ˜¾ç¤ºæ—¶å½“æˆ"æ‰‹"ï¼ˆé”™è¯¯ï¼‰
â””â”€â”€ ç”¨æˆ·çœ‹åˆ°æ”¾å¤§100å€çš„æ•°å€¼
```

**ä¿®å¤å†…å®¹**:

1. **historical_data_service.py:116-119**
   ```python
   # ä¿®æ”¹å‰ï¼šå°†"æ‰‹"Ã—100è½¬ä¸º"è‚¡"
   data['volume'] = data['volume'] * 100
   
   # ä¿®æ”¹åï¼šä¿æŒ"æ‰‹"å•ä½
   # æˆäº¤é‡ï¼šä¿æŒ"æ‰‹"å•ä½ï¼ˆä¸å†è½¬æ¢ä¸ºè‚¡ï¼‰
   ```

2. **tushare_adapter.py:266, 384**
   ```python
   # ä¿®æ”¹å‰ï¼švol = vol * 100
   # ä¿®æ”¹åï¼šç›´æ¥ä½¿ç”¨"æ‰‹"å•ä½
   ```

3. **akshare_adapter.py:478**
   ```python
   # ä¿®æ”¹å‰ï¼šæ ¹æ®å­—æ®µååˆ¤æ–­å¹¶Ã—100
   if "æ‰‹" in volume_col or volume_col in [...]:
       vol = vol * 100
   
   # ä¿®æ”¹åï¼šç»Ÿä¸€ä½¿ç”¨"æ‰‹"å•ä½
   # ä¸å†è½¬æ¢ï¼ŒAKShare è¿”å›çš„å·²ç»æ˜¯"æ‰‹"
   ```

4. **data_source_manager.py:782**
   - æ›´æ–°æ³¨é‡Šï¼Œè¯´æ˜ MongoDB ç°åœ¨æ­£ç¡®å­˜å‚¨"æ‰‹"å•ä½
   - æ·»åŠ ä¿®å¤è®°å½•å’Œæ•°æ®æ¸…ç†è¯´æ˜

**æ•°æ®æ¸…ç†æ­¥éª¤**:

```bash
# 1. æ¸…ç† MongoDB ä¸­é”™è¯¯å•ä½çš„æ•°æ®
python scripts/clear_volume_data.py

# 2. é‡æ–°å¯¼å…¥æ•°æ®ï¼ˆä½¿ç”¨ä¿®å¤åçš„ä»£ç ï¼‰
python scripts/import/import_a_stocks_unified.py --data-source tushare

# 3. éªŒè¯æˆäº¤é‡å•ä½æ˜¯å¦æ­£ç¡®
python scripts/test_volume_unit.py
```

**éªŒè¯æ–¹æ³•**:

```bash
# æ£€æŸ¥ MongoDB ä¸­çš„æ•°æ®
python -c "
from app.core.database import get_database
db = get_database()
doc = db.historical_data.find_one({'symbol': '600765'})
if doc:
    print(f\"Volume: {doc.get('volume', 0):,.0f}\")
    print(f\"é¢„æœŸ: å¦‚æœ>1,000,000åˆ™æ˜¯'è‚¡'ï¼ˆé”™è¯¯ï¼‰ï¼Œ<100,000åˆ™æ˜¯'æ‰‹'ï¼ˆæ­£ç¡®ï¼‰\")
"
```

**å—å½±å“çš„é›†åˆ**:
- `historical_data` - å®Œå…¨åˆ é™¤åé‡æ–°å¯¼å…¥
- `stock_daily_quotes` - æ¸…é™¤ volume å­—æ®µ
- `realtime_quotes` - å®Œå…¨åˆ é™¤
- `market_quotes` - æ¸…é™¤ volume å­—æ®µ

**å•ä½ç¡®è®¤ (2026-01-30)**:
- Tushare: "æ‰‹" âœ…
- AKShare: "æ‰‹" âœ…
- BaoStock: "æ‰‹" âœ…
- MongoDB: ä¿®å¤å‰="è‚¡"ï¼Œä¿®å¤å="æ‰‹" âœ…
- æŠ¥å‘Šæ˜¾ç¤º: "æ‰‹" âœ…

---

### ğŸ”´ æˆäº¤é‡/æˆäº¤é¢å•ä½å®Œå…¨ç»Ÿä¸€ (2026-01-30)

**ç»Ÿä¸€æ ‡å‡†**:
- **æˆäº¤é‡**: å…¨éƒ¨ä½¿ç”¨ **"æ‰‹"** å•ä½ï¼ˆ1æ‰‹=100è‚¡ï¼‰
- **æˆäº¤é¢**: å…¨éƒ¨ä½¿ç”¨ **"å…ƒ"** å•ä½

**ä¿®æ”¹èŒƒå›´**: è¦†ç›–æ‰€æœ‰æ•°æ®æºå’Œå®æ—¶è¡Œæƒ…

**1. å®æ—¶è¡Œæƒ…ç»Ÿä¸€**:

```python
# data_source_manager.py

# æ–°æµªå®æ—¶è¡Œæƒ…ï¼ˆä¿®æ”¹å‰ï¼‰
volume = int(float(data[8])) * 100  # è½¬æ¢ä¸ºè‚¡ âŒ
logger.info(f"æˆäº¤é‡={volume:,.0f}è‚¡")

# æ–°æµªå®æ—¶è¡Œæƒ…ï¼ˆä¿®æ”¹åï¼‰
volume = int(float(data[8]))  # å•ä½ï¼šæ‰‹ âœ…
logger.info(f"æˆäº¤é‡={volume:,.0f}æ‰‹")

# ä¸œæ–¹è´¢å¯Œå®æ—¶è¡Œæƒ…ï¼ˆä¿®æ”¹å‰ï¼‰
volume_in_shares = volume_in_lots * 100  # è½¬æ¢ä¸ºè‚¡ âŒ

# ä¸œæ–¹è´¢å¯Œå®æ—¶è¡Œæƒ…ï¼ˆä¿®æ”¹åï¼‰
volume = volume_in_lots  # å•ä½ï¼šæ‰‹ âœ…
```

**2. æ•°æ®æ ‡å‡†åŒ–å™¨æ›´æ–°**:

```python
# data_standardizer.pyï¼ˆä¿®æ”¹å‰ï¼‰
def standardize_volume(volume, unit=None):
    """æ ‡å‡†åŒ–æˆäº¤é‡åˆ°"è‚¡"""
    if unit == 'lots':
        return volume * 100  # æ‰‹â†’è‚¡ âŒ

# data_standardizer.pyï¼ˆä¿®æ”¹åï¼‰
def standardize_volume(volume, unit=None):
    """æ ‡å‡†åŒ–æˆäº¤é‡åˆ°"æ‰‹"""
    if unit == 'shares':
        return volume / 100  # è‚¡â†’æ‰‹ âœ…
```

**3. Schema æ³¨é‡Šæ›´æ–°**:

```python
# stock_historical_schema.py
volume: Optional[float] = None  # æˆäº¤é‡ï¼ˆæ‰‹ï¼‰- 2026-01-30ç»Ÿä¸€å•ä½ âœ…
amount: Optional[float] = None  # æˆäº¤é¢ï¼ˆå…ƒï¼‰- ç»Ÿä¸€å•ä½ âœ…
```

**4. ä¼˜åŒ–æ•°æ®æä¾›å™¨**:

```python
# optimized_china_data.py
# ä¿®æ”¹å‰ï¼šæ‰‹â†’è‚¡è½¬æ¢
if volume_unit == "lots":
    volume_value = volume_value * 100  # âŒ

# ä¿®æ”¹åï¼šç»Ÿä¸€ä¸ºæ‰‹
if volume_value > 1000000:
    volume_value = volume_value / 100  # è‚¡â†’æ‰‹ï¼ˆå®¹é”™å¤„ç†ï¼‰âœ…
volume = f"{int(volume_value):,}æ‰‹"
```

**å•ä½ç¡®è®¤ (2026-01-30 æœ€ç»ˆç‰ˆ)**:

| æ•°æ®ç±»å‹ | æ•°æ®æº | å•ä½ | çŠ¶æ€ |
|---------|--------|------|------|
| å†å²æ•°æ® | Tushare/AKShare/BaoStock | æ‰‹ | âœ… |
| å®æ—¶è¡Œæƒ… | æ–°æµª/ä¸œæ–¹è´¢å¯Œ | æ‰‹ | âœ… |
| MongoDBå­˜å‚¨ | Appå±‚ | æ‰‹ | âœ… |
| æŠ¥å‘Šæ˜¾ç¤º | æ‰€æœ‰åˆ†æå¸ˆ | æ‰‹ | âœ… |
| æˆäº¤é¢ | æ‰€æœ‰æ•°æ®æº | å…ƒ | âœ… |

---

### ğŸ”´ å®æ—¶è¡Œæƒ…åˆ¤æ–­é€»è¾‘ä¿®å¤ (2026-01-30)

**é—®é¢˜ç°è±¡**: ç”¨æˆ·æŒ‡å®šåˆ†æå†å²æ—¥æœŸï¼ˆå¦‚ 2024-06-01ï¼‰æ—¶ï¼Œç³»ç»Ÿé”™è¯¯åœ°ä½¿ç”¨äº†å½“å‰å®æ—¶è¡Œæƒ…

**æ ¹æœ¬åŸå› **: 
```
should_use_realtime_quote(symbol)  # åªä¼ å…¥è‚¡ç¥¨ä»£ç 
â””â”€â”€ ä½¿ç”¨ datetime.now() åˆ¤æ–­å½“å‰æ—¶é—´
    â””â”€â”€ å†å²æ—¥æœŸåˆ†ææ—¶è¢«è¯¯åˆ¤ä¸º"ç›˜ä¸­"ï¼Œä½¿ç”¨å®æ—¶è¡Œæƒ… âŒ
```

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®æ”¹å‰
should_use_rt, reason = MarketTimeUtils.should_use_realtime_quote(symbol)

# ä¿®æ”¹å
should_use_rt, reason = MarketTimeUtils.should_use_realtime_quote(
    symbol, 
    analysis_date=analysis_date  # ä¼ å…¥ç”¨æˆ·æŒ‡å®šçš„åˆ†ææ—¥æœŸ
)
```

**æ™ºèƒ½åˆ¤æ–­é€»è¾‘**:
```python
def should_use_realtime_quote(symbol, analysis_date, check_time):
    today = check_time.strftime("%Y-%m-%d")
    
    # 1. å†å²æ—¥æœŸï¼šç»å¯¹ä¸ä½¿ç”¨å®æ—¶è¡Œæƒ…
    if analysis_date < today:
        return False, "âš¡ å†å²åˆ†æï¼Œä½¿ç”¨å†å²æ”¶ç›˜ä»·"
    
    # 2. æœªæ¥æ—¥æœŸï¼šä½¿ç”¨æœ€æ–°å†å²æ•°æ®
    if analysis_date > today:
        return False, "ğŸ“… æœªæ¥æ—¥æœŸï¼Œä½¿ç”¨æœ€æ–°å†å²æ•°æ®"
    
    # 3. ä»Šå¤©ï¼šæ ¹æ®äº¤æ˜“æ—¶é—´åˆ¤æ–­
    if ç›˜ä¸­:
        return True, "âš¡ ç›˜ä¸­åˆ†æï¼Œä½¿ç”¨å®æ—¶è¡Œæƒ…"
    elif ç›˜å‰:
        return False, "âš¡ ç›˜å‰åˆ†æï¼Œä½¿ç”¨æ˜¨æ—¥æ”¶ç›˜ä»·"
    elif ç›˜å:
        return False, "ğŸ“Š ç›˜ååˆ†æï¼Œä½¿ç”¨ä»Šæ—¥æ”¶ç›˜ä»·"
```

**åœºæ™¯è¦†ç›–**:

| åˆ†ææ—¥æœŸ | å½“å‰æ—¶é—´ | ä¿®å¤å‰è¡Œä¸º | ä¿®å¤åè¡Œä¸º |
|---------|---------|-----------|-----------|
| 2024-06-01 (å†å²) | ä»»æ„ | âŒ é”™è¯¯ä½¿ç”¨å®æ—¶è¡Œæƒ… | âœ… ä½¿ç”¨å†å²æ•°æ® |
| 2026-01-30 (ä»Šå¤©) | 08:00 ç›˜å‰ | âš ï¸ å¯èƒ½å¤±è´¥ | âœ… ä½¿ç”¨æ˜¨æ—¥æ”¶ç›˜ä»· |
| 2026-01-30 (ä»Šå¤©) | 10:00 ç›˜ä¸­ | âœ… æ­£ç¡® | âœ… ä½¿ç”¨å®æ—¶è¡Œæƒ… |
| 2026-01-30 (ä»Šå¤©) | 16:00 ç›˜å | âš ï¸ å¯èƒ½ä¸å®Œæ•´ | âœ… ä½¿ç”¨ä»Šæ—¥æ”¶ç›˜ä»· |

**ä¿®æ”¹æ–‡ä»¶**:
1. `tradingagents/utils/market_time.py:216` - æ·»åŠ  analysis_date å‚æ•°
2. `tradingagents/dataflows/data_source_manager.py:1815` - ä¼ å…¥ analysis_date
3. `tradingagents/utils/market_time.py:336,363,380` - æ›´æ–°è°ƒç”¨ç‚¹

**æŠ¥å‘Šæ ‡æ³¨**:
- âš¡ ç›˜ä¸­åˆ†æ - ä½¿ç”¨å®æ—¶è¡Œæƒ…
- âš¡ ç›˜å‰åˆ†æ - ä½¿ç”¨æ˜¨æ—¥æ”¶ç›˜ä»·
- ğŸ“Š ç›˜ååˆ†æ - ä½¿ç”¨ä»Šæ—¥æ”¶ç›˜ä»·
- âš¡ å†å²åˆ†æ - ä½¿ç”¨å†å²æ”¶ç›˜ä»·

---

## ç³»ç»Ÿæ¶æ„æ·±åº¦è§£æ

### å®Œæ•´æ•°æ®æµæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·äº¤äº’å±‚ (Web/Frontend)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  å•è‚¡åˆ†æé¡µé¢ â”‚  â”‚  æ‰¹é‡åˆ†æé¡µé¢ â”‚  â”‚  åˆ†æå†å²é¡µé¢ â”‚  â”‚  å®æ—¶é€šçŸ¥ä¸­å¿ƒ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           API/WebSocket å±‚ (FastAPI)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Analysis API â”‚  â”‚  SSE Stream  â”‚  â”‚  WebSocket   â”‚  â”‚ Queue Serviceâ”‚     â”‚
â”‚  â”‚  /api/analysisâ”‚  â”‚ /api/stream  â”‚  â”‚  /api/ws/*   â”‚  â”‚ /api/queue   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤šæ™ºèƒ½ä½“åˆ†æå¼•æ“ (LangGraph)                          â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Data Coordinatorâ”‚â”€â”€â”€â–¶â”‚         åˆ†æå¸ˆå›¢é˜Ÿ (å¹¶è¡Œæ‰§è¡Œ)                     â”‚ â”‚
â”‚  â”‚    (æ•°æ®åè°ƒå™¨)   â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚ Market  â”‚â”‚Social   â”‚â”‚  News   â”‚â”‚Fundamen-â”‚ â”‚ â”‚
â”‚                         â”‚  â”‚ Analyst â”‚â”‚Media    â”‚â”‚ Analyst â”‚â”‚tals     â”‚ â”‚ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚         â”‚â”‚Analyst  â”‚â”‚         â”‚â”‚Analyst  â”‚ â”‚ â”‚
â”‚  â”‚  ç ”ç©¶å‘˜è¾©è®ºæœºåˆ¶  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”‚    â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚ â”‚
â”‚  â”‚ â”‚Bull â”‚â†”â”‚Bear â”‚ â”‚    â”‚           â”‚ China   â”‚                           â”‚ â”‚
â”‚  â”‚ â”‚Res. â”‚ â”‚Res. â”‚ â”‚    â”‚           â”‚ Market  â”‚                           â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â”‚    â”‚           â”‚ Analyst â”‚                           â”‚ â”‚
â”‚  â”‚      â†“          â”‚    â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚ â”‚
â”‚  â”‚  Research Mgr   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚                             â”‚ â”‚
â”‚           â”‚                                   â–¼                             â”‚ â”‚
â”‚           â–¼                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚        Trader           â”‚                  â”‚ â”‚
â”‚  â”‚  é£é™©ç®¡ç†è¾©è®º    â”‚           â”‚    (äº¤æ˜“å‘˜åˆ¶å®šè®¡åˆ’)      â”‚                  â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â” â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â”‚
â”‚  â”‚ â”‚Riskyâ”‚â”‚ Safe â”‚ â”‚                      â”‚                                  â”‚ â”‚
â”‚  â”‚ â”‚     â”‚â”‚      â”‚ â”‚                      â–¼                                  â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜ â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚           â”‚    Risk Debate (3-way)  â”‚                  â”‚ â”‚
â”‚  â”‚ â”‚   Neutral   â”‚ â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”‚                  â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚           â”‚  â”‚Riskyâ”‚â”‚ Safe â”‚â”‚Neutralâ”‚                  â”‚ â”‚
â”‚  â”‚        â†“        â”‚           â”‚  â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜â”‚                  â”‚ â”‚
â”‚  â”‚   Risk Manager  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚                                  â”‚ â”‚
â”‚                                           â–¼                                  â”‚ â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚ â”‚
â”‚                              â”‚    Final Decision       â”‚                     â”‚ â”‚
â”‚                              â”‚    (æœ€ç»ˆäº¤æ˜“å†³ç­–)        â”‚                     â”‚ â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ•°æ®å±‚ (Data Layer)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   MongoDB    â”‚  â”‚    Redis     â”‚  â”‚  Tushare API â”‚  â”‚  AKShare API â”‚     â”‚
â”‚  â”‚  (æŒä¹…åŒ–å­˜å‚¨) â”‚  â”‚  (ç¼“å­˜/é˜Ÿåˆ—)  â”‚  â”‚  (æ•°æ®æº1)   â”‚  â”‚  (æ•°æ®æº2)   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚  â”‚ BaoStock API â”‚                                                           â”‚
â”‚  â”‚  (æ•°æ®æº3)   â”‚                                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ç¬¬ä¸€é˜¶æ®µï¼šè‚¡ç¥¨ä¿¡æ¯è·å–

#### 1. æ•°æ®æºç®¡ç†æ¶æ„

**æ ¸å¿ƒç»„ä»¶**ï¼š
| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|----------|------|
| æ•°æ®æºç®¡ç†å™¨ | `tradingagents/dataflows/data_source_manager.py` | ç»Ÿä¸€æ¥å£ï¼Œæ™ºèƒ½é™çº§ |
| Tushareæä¾›å™¨ | `tradingagents/dataflows/providers/china/tushare.py` | é«˜è´¨é‡æ•°æ®ï¼Œéœ€ç§¯åˆ† |
| AKShareæä¾›å™¨ | `tradingagents/dataflows/providers/china/akshare.py` | å…è´¹å¼€æºï¼Œçˆ¬è™«è·å– |
| BaoStockæä¾›å™¨ | `tradingagents/dataflows/providers/china/baostock.py` | å…è´¹å¼€æºï¼Œæ•°æ®ç¨³å®š |

#### 2. æ•°æ®æºä¼˜å…ˆçº§ä¸é™çº§ç­–ç•¥

```python
# tradingagents/dataflows/data_source_manager.py:106-160
# é»˜è®¤ä¼˜å…ˆçº§ï¼šTushare > AKShare > BaoStock
env_priority = os.getenv(
    "HISTORICAL_DATA_SOURCE_PRIORITY", "tushare,akshare,baostock"
)
```

**ä¼˜å…ˆçº§ç­–ç•¥**ï¼š
1. **Tushare** - æ•°æ®è´¨é‡æœ€é«˜ï¼Œéœ€è¦ç§¯åˆ†
2. **AKShare** - å…è´¹å¼€æºï¼ŒåŸºäºçˆ¬è™«
3. **BaoStock** - å…è´¹å¼€æºï¼Œæ•°æ®ç¨³å®š

#### 3. å®æ—¶è¡Œæƒ…è·å–é€»è¾‘

```python
# tradingagents/dataflows/data_source_manager.py:1453-1517
def get_realtime_quote(self, symbol: str) -> Optional[Dict]:
    """
    è·å–å®æ—¶è¡Œæƒ…æ•°æ® - åªä½¿ç”¨å¤–éƒ¨APIï¼Œä¸ä½¿ç”¨MongoDBç¼“å­˜
    """
```

**å®æ—¶è¡Œæƒ…ä¼˜å…ˆçº§**ï¼š
- AKShare ä¼˜å…ˆçº§: 1 (ä¼˜å…ˆ)
- Tushare ä¼˜å…ˆçº§: 2 (å¤‡é€‰)

#### 4. å¸‚åœºæ—¶é—´æ™ºèƒ½åˆ¤æ–­

```python
# tradingagents/utils/market_time.py:216-295
def should_use_realtime_quote(symbol, analysis_date, check_time):
    """
    æ™ºèƒ½åˆ¤æ–­æ˜¯å¦ä½¿ç”¨å®æ—¶è¡Œæƒ…
    - å†å²æ—¥æœŸï¼ˆ<ä»Šå¤©ï¼‰ï¼šç»å¯¹ä¸ä½¿ç”¨å®æ—¶è¡Œæƒ…
    - ä»Šå¤© + ç›˜ä¸­ï¼šä½¿ç”¨å®æ—¶è¡Œæƒ…
    - ä»Šå¤© + ç›˜å‰/ç›˜åï¼šä¸ä½¿ç”¨å®æ—¶è¡Œæƒ…
    """
    if analysis_date < today:
        return False, "âš¡ å†å²åˆ†æï¼Œä½¿ç”¨å†å²æ”¶ç›˜ä»·"

    if is_trading:
        return True, "âš¡ ç›˜ä¸­åˆ†æï¼Œä½¿ç”¨å®æ—¶è¡Œæƒ…"
    elif "ç›˜å‰" in status:
        return False, "âš¡ ç›˜å‰åˆ†æï¼Œä½¿ç”¨æ˜¨æ—¥æ”¶ç›˜ä»·"
    elif "ç›˜å" in status:
        return False, "ğŸ“Š ç›˜ååˆ†æï¼Œä½¿ç”¨ä»Šæ—¥æ”¶ç›˜ä»·"
```

**åœºæ™¯è¦†ç›–**ï¼š

| åˆ†ææ—¥æœŸ | å½“å‰æ—¶é—´ | æ˜¯å¦ä½¿ç”¨å®æ—¶è¡Œæƒ… | è¯´æ˜ |
|---------|---------|----------------|------|
| 2024-06-01 (å†å²) | ä»»æ„ | å¦ | ä½¿ç”¨å†å²æ•°æ® |
| ä»Šå¤© | 08:00 (ç›˜å‰) | å¦ | ä½¿ç”¨æ˜¨æ—¥æ”¶ç›˜ä»· |
| ä»Šå¤© | 10:00 (ç›˜ä¸­) | æ˜¯ | ä½¿ç”¨å®æ—¶è¡Œæƒ… |
| ä»Šå¤© | 16:00 (ç›˜å) | å¦ | ä½¿ç”¨ä»Šæ—¥æ”¶ç›˜ä»· |

#### 5. æ•°æ®æ ‡å‡†åŒ–

**æˆäº¤é‡å•ä½ç»Ÿä¸€**ï¼š
- **ç»Ÿä¸€æ ‡å‡†**: å…¨éƒ¨ä½¿ç”¨ **"æ‰‹"** å•ä½ï¼ˆ1æ‰‹=100è‚¡ï¼‰
- **æˆäº¤é¢**: å…¨éƒ¨ä½¿ç”¨ **"å…ƒ"** å•ä½

```python
# tradingagents/dataflows/standardizers/data_standardizer.py:32-83
@staticmethod
def standardize_volume(volume: Any, unit: Optional[str] = None) -> Dict[str, Any]:
    """æ ‡å‡†åŒ–æˆäº¤é‡åˆ°"æ‰‹"ï¼ˆ2026-01-30ç»Ÿä¸€å•ä½ï¼‰"""
    if unit == "shares":
        volume_in_lots = volume / DataStandardizer.SHARES_PER_LOT
```

---

### ç¬¬äºŒé˜¶æ®µï¼šå¤šæ™ºèƒ½ä½“åˆ†æ

#### 1. åˆ†æå¸ˆå›¢é˜Ÿ

| åˆ†æå¸ˆ | æ–‡ä»¶è·¯å¾„ | èŒè´£ | è¾“å‡º |
|--------|----------|------|------|
| å¸‚åœºåˆ†æå¸ˆ | `tradingagents/agents/analysts/market_analyst.py` | æŠ€æœ¯åˆ†æï¼ˆMA/MACD/RSI/å¸ƒæ—å¸¦ï¼‰ | `market_report` |
| åŸºæœ¬é¢åˆ†æå¸ˆ | `tradingagents/agents/analysts/fundamentals_analyst.py` | è´¢åŠ¡åˆ†æï¼ˆPE/PB/ROE/ç°é‡‘æµï¼‰ | `fundamentals_report` |
| æ–°é—»åˆ†æå¸ˆ | `tradingagents/agents/analysts/news_analyst.py` | æ¶ˆæ¯é¢åˆ†æï¼ˆæ–°é—»/æ”¿ç­–/å…¬å‘Šï¼‰ | `news_report` |
| ä¸­å›½å¸‚åœºåˆ†æå¸ˆ | `tradingagents/agents/analysts/china_market_analyst.py` | Aè‚¡ç‰¹è‰²ï¼ˆæ¶¨è·Œåœ/æ¢æ‰‹ç‡/é‡æ¯”ï¼‰ | `china_market_report` |
| ç¤¾äº¤åª’ä½“åˆ†æå¸ˆ | `tradingagents/agents/analysts/social_media_analyst.py` | æƒ…ç»ªåˆ†æï¼ˆæ•£æˆ·æƒ…ç»ª/çƒ­åº¦ï¼‰ | `sentiment_report` |

**åˆ†æå¸ˆæç¤ºè¯è®¾è®¡æ¨¡å¼**ï¼š

```python
# ä»¥å¸‚åœºåˆ†æå¸ˆä¸ºä¾‹
system_message = f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è‚¡ç¥¨æŠ€æœ¯åˆ†æå¸ˆã€‚
è¯·åŸºäºä»¥ä¸‹**çœŸå®å¸‚åœºæ•°æ®**å¯¹ {company_name} ({ticker}) è¿›è¡Œè¯¦ç»†çš„æŠ€æœ¯åˆ†æã€‚

=== æ•°æ®ä¿¡æ¯ ===
- æ•°æ®æ¥æº: {market_source}
- æ•°æ®æ—¥æœŸ: {current_date}ï¼ˆå†å²æ•°æ®ï¼‰
{metadata_info}

=== å¸‚åœºæ•°æ® ===
{market_data}
================

**åˆ†æè¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š**
1. **æ•°æ®æ¥æº**ï¼šå¿…é¡»ä¸¥æ ¼åŸºäºä¸Šè¿°æä¾›çš„å¸‚åœºæ•°æ®è¿›è¡Œåˆ†æï¼Œç»å¯¹ç¦æ­¢ç¼–é€ æ•°æ®ã€‚
2. **æŠ€æœ¯æŒ‡æ ‡**ï¼šåˆ†æç§»åŠ¨å¹³å‡çº¿ï¼ˆMAï¼‰ã€MACDã€RSIã€å¸ƒæ—å¸¦ç­‰æŒ‡æ ‡ã€‚
3. **æˆäº¤é‡**ï¼šåˆ†æé‡ä»·é…åˆæƒ…å†µï¼ˆæˆäº¤é‡å•ä½ä¸º"æ‰‹"ï¼Œ1æ‰‹=100è‚¡ï¼‰ã€‚
4. **æŠ•èµ„å»ºè®®**ï¼šç»™å‡ºæ˜ç¡®çš„ä¹°å…¥/æŒæœ‰/å–å‡ºå»ºè®®ã€‚
"""
```

#### 2. ç ”ç©¶å‘˜è¾©è®ºæœºåˆ¶

**è¾©è®ºæµç¨‹**ï¼š
```
Bull Researcher (çœ‹æ¶¨) â†” Bear Researcher (çœ‹è·Œ)
           â†“
    Research Manager (ç ”ç©¶ç»ç†)
           â†“
      Investment Plan (æŠ•èµ„è®¡åˆ’)
```

**å…³é”®ä»£ç **ï¼š

```python
# tradingagents/graph/conditional_logic.py:202-243
def should_continue_debate(self, state: AgentState) -> str:
    """Determine if debate should continue."""
    current_count = state["investment_debate_state"]["count"]
    max_count = 2 * self.max_debate_rounds

    if current_count >= max_count:
        return "Research Manager"

    next_speaker = "Bear Researcher" if current_speaker.startswith("Bull") else "Bull Researcher"
    return next_speaker
```

**ç ”ç©¶å‘˜èŒè´£**ï¼š

| ç ”ç©¶å‘˜ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|--------|----------|------|
| çœ‹æ¶¨ç ”ç©¶å‘˜ | `tradingagents/agents/researchers/bull_researcher.py` | æ„å»ºçœ‹æ¶¨æ¡ˆä¾‹ï¼Œåé©³çœ‹è·Œè®ºç‚¹ |
| çœ‹è·Œç ”ç©¶å‘˜ | `tradingagents/agents/researchers/bear_researcher.py` | æ„å»ºçœ‹è·Œæ¡ˆä¾‹ï¼Œåé©³çœ‹æ¶¨è®ºç‚¹ |
| ç ”ç©¶ç»ç† | `tradingagents/agents/managers/research_manager.py` | è¯„ä¼°è¾©è®ºï¼Œåšå‡ºæŠ•èµ„å†³ç­– |

#### 3. äº¤æ˜“å‘˜å†³ç­–

**äº¤æ˜“å‘˜èŒè´£**ï¼š
- åŸºäºæ‰€æœ‰åˆ†æå¸ˆæŠ¥å‘Šå’Œè¾©è®ºç»“æœ
- æä¾›å…·ä½“çš„æŠ•èµ„å»ºè®®ï¼ˆä¹°å…¥/æŒæœ‰/å–å‡ºï¼‰
- **å¼ºåˆ¶è¦æ±‚**: å¿…é¡»æä¾›å…·ä½“çš„ç›®æ ‡ä»·ä½
- ç»™å‡ºç½®ä¿¡åº¦å’Œé£é™©è¯„åˆ†

```python
# tradingagents/agents/trader/trader.py:14-160
def extract_trading_decision(content: str, current_price: float = None) -> dict:
    result = {
        "recommendation": "æœªçŸ¥",  # ä¹°å…¥/æŒæœ‰/å–å‡º
        "target_price": None,
        "target_price_range": None,
        "confidence": None,  # ç½®ä¿¡åº¦
        "risk_score": None,  # é£é™©è¯„åˆ†
        "current_price": None,
        "stop_loss": None,  # æ­¢æŸä½
        "position_suggestion": None,  # ä»“ä½å»ºè®®
        "time_horizon": None,  # æ—¶é—´çª—å£
        "entry_strategy": None,  # å»ºä»“ç­–ç•¥
        "warnings": [],
    }
```

#### 4. é£é™©ç®¡ç†è¾©è®º

**ä¸‰ç§é£é™©åˆ†æå¸ˆ**ï¼š

| ç±»å‹ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|----------|------|
| æ¿€è¿›åˆ†æå¸ˆ | `tradingagents/agents/risk_mgmt/aggresive_debator.py` | å…³æ³¨ä¸Šæ¶¨ç©ºé—´å’Œå¢é•¿æ½œåŠ› |
| ä¿å®ˆåˆ†æå¸ˆ | `tradingagents/agents/risk_mgmt/conservative_debator.py` | å…³æ³¨é£é™©ç¼“è§£å’Œèµ„äº§ä¿æŠ¤ |
| ä¸­æ€§åˆ†æå¸ˆ | `tradingagents/agents/risk_mgmt/neutral_debator.py` | æä¾›å¹³è¡¡è§†è§’ |

**é£é™©è¾©è®ºæµç¨‹**ï¼š
```
Trader (äº¤æ˜“è®¡åˆ’)
  â†“
Risky Analyst (æ¿€è¿›) â†’ Safe Analyst (ä¿å®ˆ) â†’ Neutral Analyst (ä¸­æ€§)
                          â†“
                   Risk Manager (æœ€ç»ˆå†³ç­–)
                          â†“
              Final Trade Decision (æœ€ç»ˆäº¤æ˜“å†³ç­–)
```

---

### ç¬¬ä¸‰é˜¶æ®µï¼šå·¥ä½œæµç¼–æ’

#### 1. LangGraph çŠ¶æ€å®šä¹‰

```python
# tradingagents/agents/utils/agent_states.py
class AgentState(MessagesState):
    # åŸºç¡€ä¿¡æ¯
    company_of_interest: str  # è‚¡ç¥¨ä»£ç 
    trade_date: str  # åˆ†ææ—¥æœŸ

    # ä¸­å¤®æ•°æ®å­˜å‚¨ (ç”±DataCoordinatoré¢„å–)
    market_data: str  # åŸå§‹å¸‚åœºæ•°æ®
    financial_data: str  # åŸå§‹è´¢åŠ¡æ•°æ®
    news_data: str  # åŸå§‹æ–°é—»æ•°æ®
    sentiment_data: str  # åŸå§‹æƒ…ç»ªæ•°æ®

    # åˆ†æå¸ˆæŠ¥å‘Š
    market_report: str
    fundamentals_report: str
    news_report: str
    china_market_report: str
    sentiment_report: str

    # ç ”ç©¶å›¢é˜Ÿè¾©è®ºçŠ¶æ€
    investment_debate_state: InvestDebateState
    investment_plan: str  # æŠ•èµ„è®¡åˆ’
    trader_investment_plan: str  # äº¤æ˜“å‘˜è®¡åˆ’

    # é£é™©ç®¡ç†å›¢é˜Ÿè¾©è®ºçŠ¶æ€
    risk_debate_state: RiskDebateState
    final_trade_decision: str  # æœ€ç»ˆäº¤æ˜“å†³ç­–
```

#### 2. å®Œæ•´å·¥ä½œæµ

```
START
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Coordinator â”‚  â† é¢„åŠ è½½æ‰€æœ‰æ•°æ®
â”‚   (æ•°æ®åè°ƒå™¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â–¼                 â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Market   â”‚  â”‚ Social   â”‚  â”‚ News     â”‚  â”‚Fundamentalsâ”‚ â”‚ China    â”‚
â”‚ Analyst  â”‚  â”‚ Analyst  â”‚  â”‚ Analyst  â”‚  â”‚ Analyst   â”‚  â”‚ Analyst  â”‚
â”‚ (å¹¶è¡Œ)   â”‚  â”‚ (å¹¶è¡Œ)   â”‚  â”‚ (å¹¶è¡Œ)   â”‚  â”‚ (å¹¶è¡Œ)    â”‚  â”‚ (å¹¶è¡Œ)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚              â”‚              â”‚              â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bull Researcher â”‚ â†”ï¸  â”‚ Bear Researcher â”‚
â”‚  (å¤šå¤´è§‚ç‚¹)      â”‚     â”‚  (ç©ºå¤´è§‚ç‚¹)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Research Managerâ”‚  â† ç»¼åˆå†³ç­–ï¼Œç”ŸæˆæŠ•èµ„è®¡åˆ’
â”‚  (ç ”ç©¶ç»ç†)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Trader      â”‚  â† åˆ¶å®šäº¤æ˜“è®¡åˆ’
â”‚   (äº¤æ˜“å‘˜)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Risky Analyst  â”‚ â†”ï¸  â”‚  Safe Analyst   â”‚ â†”ï¸  â”‚ Neutral Analyst â”‚
â”‚   (æ¿€è¿›)        â”‚     â”‚   (ä¿å®ˆ)        â”‚     â”‚   (ä¸­æ€§)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Risk Manager  â”‚  â† æœ€ç»ˆäº¤æ˜“å†³ç­–
â”‚  (é£é™©ç®¡ç†å‘˜)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
 END
```

#### 3. ä¸»å›¾æ‰§è¡Œæµç¨‹

```python
# tradingagents/graph/trading_graph.py:967-1184
def propagate(self, company_name, trade_date, progress_callback=None, task_id=None):
    """Run the trading agents graph for a company on a specific date."""

    # åŒæ­¥æ—¥æœŸåˆ°å…¨å±€é…ç½®
    if trade_date is not None:
        Toolkit._config["trade_date"] = str(trade_date)
        Toolkit._config["analysis_date"] = str(trade_date)

    # åˆ›å»ºåˆå§‹çŠ¶æ€
    init_agent_state = self.propagator.create_initial_state(company_name, trade_date)

    # æ‰§è¡Œå›¾å·¥ä½œæµ
    for chunk in self.graph.stream(init_agent_state, **args):
        # è®°å½•èŠ‚ç‚¹æ‰§è¡Œæ—¶é—´
        for node_name in chunk.keys():
            if not node_name.startswith("__"):
                # è®°å½•èŠ‚ç‚¹æ‰§è¡Œæ—¶é—´...

        # å‘é€è¿›åº¦æ›´æ–°
        if progress_callback:
            self._send_progress_update(chunk, progress_callback)

    # å¤„ç†æœ€ç»ˆå†³ç­–
    decision = self.process_signal(final_state["final_trade_decision"], company_name)

    return final_state, decision
```

---

### ç¬¬å››é˜¶æ®µï¼šæŠ¥å‘Šç”Ÿæˆ

#### 1. æŠ¥å‘Šç”Ÿæˆå™¨

**æ ¸å¿ƒæ–‡ä»¶**ï¼š
| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `tradingagents/templates/report_templates.py` | ç»Ÿä¸€æŠ¥å‘Šæ¨¡æ¿å®šä¹‰ |
| `app/utils/report_exporter.py` | åç«¯æŠ¥å‘Šå¯¼å‡ºå·¥å…· |
| `web/utils/report_exporter.py` | Webç«¯æŠ¥å‘Šå¯¼å‡ºå·¥å…· |

**æ”¯æŒçš„æŠ¥å‘Šæ ¼å¼**ï¼š

| æ ¼å¼ | æ–¹æ³• | ä¾èµ– |
|------|------|------|
| Markdown | `generate_markdown_report()` | æ—  |
| Word | `generate_docx_report()` | pypandoc + pandoc |
| PDF | `generate_pdf_report()` | pdfkit + wkhtmltopdf |

#### 2. æŠ¥å‘ŠéªŒè¯ç³»ç»Ÿ

```python
# tradingagents/utils/report_validator.py:37-98
class ReportValidator:
    """æŠ¥å‘Šä¸€è‡´æ€§æ ¡éªŒå™¨"""

    REQUIRED_FIELDS = {
        "final_trade_decision": ["recommendation", "target_price", "confidence"],
        "fundamentals_report": ["pe_ratio", "current_price"],
        "technical_report": ["current_price", "volume"],
        "sentiment_report": ["sentiment_score"],
    }

    def validate_all_reports(self, reports: Dict[str, str], stock_code: str, company_name: str):
        # 1. æ£€æŸ¥å¿…å¡«å­—æ®µ
        self._check_required_fields(reports)
        # 2. æ£€æµ‹æŠ•èµ„å»ºè®®çŸ›ç›¾
        self._check_recommendation_conflicts(reports)
        # 3. æ£€æŸ¥ä»·æ ¼æ•°æ®ä¸€è‡´æ€§
        self._check_price_consistency(reports)
        # 4. æ£€æŸ¥æˆäº¤é‡æ•°æ®ä¸€è‡´æ€§
        self._check_volume_consistency(reports)
```

#### 3. æœ€ç»ˆå†³ç­–ç»“æ„

```python
{
    "recommendation": "ä¹°å…¥",  # ä¹°å…¥/æŒæœ‰/å–å‡º
    "target_price": 15.50,
    "target_price_range": "14.00-16.00",
    "confidence": 0.75,  # 0-1
    "risk_score": 0.6,   # 0-1ï¼Œè¶Šé«˜é£é™©è¶Šå¤§
    "current_price": 12.30,
    "stop_loss": 11.30,  # æ­¢æŸä½
    "position_suggestion": "ä¸­ç­‰ä»“ä½ (40-60%)",
    "time_horizon": "1-3ä¸ªæœˆ",
    "entry_strategy": "åˆ†æ‰¹å»ºä»“ï¼Œé¦–æ¬¡30%ï¼Œå›è°ƒåŠ ä»“",
    "warnings": ["å®è§‚ç»æµä¸ç¡®å®šæ€§", "è¡Œä¸šç«äº‰åŠ å‰§"]
}
```

---

### ç¬¬äº”é˜¶æ®µï¼šWebç•Œé¢ä¸API

#### 1. åç«¯API

**æ ¸å¿ƒç«¯ç‚¹**ï¼š
```python
# app/routers/analysis.py
POST   /api/analysis/single           # æäº¤å•è‚¡åˆ†æä»»åŠ¡
POST   /api/analysis/batch            # æäº¤æ‰¹é‡åˆ†æä»»åŠ¡
GET    /api/analysis/tasks/{id}/status # è·å–ä»»åŠ¡çŠ¶æ€
GET    /api/analysis/tasks/{id}/result # è·å–åˆ†æç»“æœ
GET    /api/analysis/tasks            # è·å–ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨
POST   /api/analysis/tasks/{id}/cancel # å–æ¶ˆä»»åŠ¡
```

#### 2. WebSocketå®æ—¶é€šçŸ¥

```python
# app/routers/websocket_notifications.py
WS /api/ws/notifications              # ç”¨æˆ·é€šçŸ¥é€šé“
WS /api/ws/tasks/{task_id}            # ä»»åŠ¡è¿›åº¦é€šé“
```

**æ¶ˆæ¯æ ¼å¼**ï¼š
```json
{
    "type": "notification",
    "data": {
        "id": "...",
        "title": "åˆ†æå®Œæˆ",
        "content": "è‚¡ç¥¨ 000001 åˆ†æå·²å®Œæˆ",
        "status": "unread",
        "created_at": "2025-10-23T12:00:00"
    }
}
```

#### 3. ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ

```python
# app/services/queue_service.py
class QueueService:
    def __init__(self, redis: Redis):
        self.user_concurrent_limit = 3      # ç”¨æˆ·å¹¶å‘é™åˆ¶
        self.global_concurrent_limit = 3    # å…¨å±€å¹¶å‘é™åˆ¶
        self.visibility_timeout = 300       # 5åˆ†é’Ÿå¯è§æ€§è¶…æ—¶
```

---

### å®Œæ•´æ•°æ®æµæ€»ç»“

```
ç”¨æˆ·è¾“å…¥è‚¡ç¥¨ä»£ç å’Œåˆ†ææ—¥æœŸ
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æ•°æ®è·å–å±‚   â”‚
â”‚  - æ ¹æ®æ—¥æœŸåˆ¤æ–­å®æ—¶/å†å²æ•°æ® â”‚
â”‚  - å¤šæ•°æ®æºæ™ºèƒ½é™çº§ (Tushareâ†’AKShareâ†’BaoStock) â”‚
â”‚  - æ•°æ®æ ‡å‡†åŒ–ï¼ˆæˆäº¤é‡ç»Ÿä¸€ä¸º"æ‰‹"ï¼‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ•°æ®åè°ƒå™¨   â”‚
â”‚  - é¢„åŠ è½½æ‰€æœ‰æ•°æ®åˆ°state â”‚
â”‚  - ä¸ºåˆ†æå¸ˆå‡†å¤‡æ•°æ® â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. åˆ†æå¸ˆå›¢é˜Ÿ   â”‚
â”‚  - 5ä¸ªåˆ†æå¸ˆå¹¶è¡Œæ‰§è¡Œ â”‚
â”‚  - å„è‡ªç”Ÿæˆä¸“ä¸šæŠ¥å‘Š â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ç ”ç©¶å‘˜è¾©è®º   â”‚
â”‚  - Bull vs Bear è¾©è®º â”‚
â”‚  - ç ”ç©¶ç»ç†ç»¼åˆå†³ç­– â”‚
â”‚  - ç”ŸæˆæŠ•èµ„è®¡åˆ’ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. äº¤æ˜“å‘˜å†³ç­–   â”‚
â”‚  - åŸºäºæ‰€æœ‰æŠ¥å‘Šåˆ¶å®šäº¤æ˜“è®¡åˆ’ â”‚
â”‚  - æå–ç»“æ„åŒ–å†³ç­–ä¿¡æ¯ â”‚
â”‚  - è®¡ç®—æ­¢æŸä½ã€ä»“ä½å»ºè®® â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. é£é™©ç®¡ç†è¾©è®º â”‚
â”‚  - Risky/Safe/Neutral ä¸‰æ–¹è¾©è®º â”‚
â”‚  - é£é™©ç®¡ç†å‘˜æœ€ç»ˆå†³ç­– â”‚
â”‚  - ç”Ÿæˆæœ€ç»ˆäº¤æ˜“å†³ç­– â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. æŠ¥å‘Šç”Ÿæˆ     â”‚
â”‚  - éªŒè¯æŠ¥å‘Šä¸€è‡´æ€§ â”‚
â”‚  - ç”ŸæˆMarkdown/PDF/WordæŠ¥å‘Š â”‚
â”‚  - ä¿å­˜åˆ°MongoDB â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. å‰ç«¯å±•ç¤º     â”‚
â”‚  - WebSocketå®æ—¶æ¨é€è¿›åº¦ â”‚
â”‚  - å±•ç¤ºåˆ†ææŠ¥å‘Š â”‚
â”‚  - æ”¯æŒæŠ¥å‘Šä¸‹è½½ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**æœ€åæ›´æ–°**: 2026-02-03
**ç‰ˆæœ¬**: 1.3.0
**é…å¥—æ–‡æ¡£**: [SKILLS.md](./skills/SKILLS.md)
