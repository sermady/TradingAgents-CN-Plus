## EVAL: data-source
Created: 2026-02-05

### 核心功能概述

TradingAgents-CN 的数据源模块提供多市场、多数据源的统一数据获取能力，支持智能降级、缓存管理和数据标准化。

**架构层次**:
1. **接口层** (`interface.py`) - 统一的数据获取入口
2. **管理层** (`data_source_manager.py`) - 数据源管理和降级策略
3. **提供层** (`providers/`) - 各数据源的具体实现
4. **标准化层** (`standardizers/`) - 数据格式和单位统一

**支持的市场**:
- A股（Tushare, AKShare, Baostock, MongoDB）
- 港股（AKShare, Yahoo Finance）
- 美股（Yahoo Finance, Finnhub）

---

### Capability Evals（能力评估）

#### 基础数据获取
- [ ] **多数据源支持**
  - 支持 Tushare、AKShare、Baostock 三大A股数据源
  - 支持 MongoDB 缓存作为最高优先级数据源
  - 每个数据源可独立配置启用/禁用

- [ ] **数据源优先级管理**
  - 支持自定义数据源优先级（通过环境变量或数据库配置）
  - 默认优先级：MongoDB → Tushare → AKShare → Baostock
  - 支持动态切换数据源

- [ ] **自动降级机制**
  - 主数据源失败时自动降级到备选数据源
  - 降级日志完整记录失败原因
  - 最终失败时返回清晰的错误信息

- [ ] **历史数据获取**
  - `get_china_stock_data_unified()` - 统一的A股历史数据获取
  - 支持指定日期范围（start_date, end_date）
  - 返回包含 OHLCV 的完整日线数据
  - 正确处理停牌日期（无数据的日期）

- [ ] **实时行情获取**
  - `get_realtime_quote()` - 获取股票实时行情
  - 支持智能判断（盘中/盘前/盘后/历史日期）
  - 历史日期分析不使用实时行情
  - 实时行情优先级：AKShare → Tushare → Baostock

- [ ] **股票信息获取**
  - `get_china_stock_info_unified()` - 获取股票基本信息
  - 包含：股票名称、行业、上市日期、市场类型
  - 支持模糊搜索（股票代码或名称）

- [ ] **基本面数据获取**
  - `get_fundamentals_data()` - 获取财务指标
  - 包含：PE、PB、ROE、总市值、流通市值
  - 支持多期数据对比

#### 数据标准化
- [ ] **成交量单位统一**
  - 所有数据源统一返回"手"单位（1手=100股）
  - Tushare/AKShare：保持原始"手"单位
  - BaoStock：从"股"转换为"手"（÷100）
  - MongoDB：正确存储"手"单位

- [ ] **成交额单位统一**
  - 所有数据源统一返回"元"单位
  - Tushare：原始"千元" → 转换为"元"（×1000）
  - AKShare/BaoStock：原始"元" → 直接使用
  - MongoDB：正确存储"元"单位

- [ ] **数据格式统一**
  - 统一的字段命名（open/high/low/close/volume/amount）
  - 统一的数据类型（float/int/date）
  - 统一的日期格式（YYYY-MM-DD）
  - 统一的缺失值处理（None）

- [ ] **技术指标计算**
  - `get_stockstats_indicator()` - 统一的技术指标计算接口
  - 支持：MA（移动平均线）、MACD、RSI、布林带（BOLL）
  - 计算结果准确无误

#### 缓存机制
- [ ] **多级缓存架构**
  - MongoDB 缓存（持久化存储）
  - Redis 缓存（高速访问）
  - 文件缓存（本地备份）
  - 统一缓存管理器（`cache_manager`）

- [ ] **缓存自动失效**
  - 历史数据缓存永久有效（除非手动清除）
  - 实时行情缓存有效期 10 分钟
  - 基本面数据缓存有效期 1 天
  - 支持手动刷新缓存

- [ ] **缓存命中率优化**
  - 高频访问的数据优先缓存
  - 大数据量使用分页加载
  - 支持缓存预热（批量导入）

#### 多市场支持
- [ ] **港股数据获取**
  - `get_hk_stock_data_unified()` - 港股历史数据
  - `get_hk_stock_info_unified()` - 港股基本信息
  - 支持 AKShare 和 Yahoo Finance 数据源

- [ ] **美股数据获取**
  - `get_YFin_data()` - Yahoo Finance 美股数据
  - `get_fundamentals_finnhub()` - Finnhub 基本面数据
  - 支持多维度指标和实时行情

#### 错误处理和日志
- [ ] **错误处理完善**
  - API 调用失败时自动重试（最多3次）
  - 网络超时处理（默认 30 秒）
  - 数据验证失败时返回 None 而非异常
  - 所有异常都有清晰的错误信息

- [ ] **日志记录完整**
  - 数据源切换日志
  - 缓存命中/未命中日志
  - 降级触发原因日志
  - 数据标准化转换日志
  - 使用统一的日志格式（颜色标签）

---

### Regression Evals（回归评估）

#### 功能回归
- [ ] **数据源降级机制不破坏**
  - Tushare 失败时正确降级到 AKShare
  - AKShare 失败时正确降级到 Baostock
  - 所有数据源都失败时返回 None，不抛异常

- [ ] **数据标准化不破坏**
  - 成交量始终保持"手"单位
  - 成交额始终保持"元"单位
  - 不同数据源的数据格式保持一致

- [ ] **缓存机制不破坏**
  - MongoDB 缓存优先级保持最高
  - 缓存失效时间正确
  - 缓存刷新功能正常

- [ ] **接口兼容性保持**
  - `interface.py` 的所有公开接口签名不变
  - 返回值格式保持一致
  - 向后兼容旧版本代码

#### 性能回归
- [ ] **数据获取性能不下降**
  - MongoDB 缓存命中时响应时间 < 50ms
  - 外部 API 调用平均响应时间 < 5s
  - 批量数据获取性能不低于 v1.0.0-preview

- [ ] **内存使用不暴涨**
  - 大数据量加载时内存使用合理
  - 缓存机制不导致内存泄漏
  - DataFrame 操作及时释放内存

---

### Success Criteria（成功标准）

#### 能力评估标准
- **pass@3 > 90%**：核心功能评估项在 3 次尝试中通过率 > 90%
- **pass@1 > 75%**：核心功能首次尝试通过率 > 75%
- **边缘场景**：所有边界条件（空数据、停牌、跨年等）都必须覆盖

#### 回归评估标准
- **pass^3 = 100%**：所有回归测试必须 100% 通过
- **无破坏性变更**：任何变更不得破坏现有功能
- **性能不下降**：关键指标响应时间不增加超过 10%

#### 代码质量标准
- **测试覆盖率 > 80%**：核心模块测试覆盖率不低于 80%
- **LSP 诊断清洁**：无 LSP 类型错误和警告
- **代码规范**：遵循项目代码风格（PEP 8）

#### 文档标准
- **API 文档完整**：所有公开函数都有清晰的文档字符串
- **使用示例**：提供常见场景的使用示例
- **变更日志**：详细记录每次变更的内容和原因

---

### 测试覆盖范围

#### 单元测试
- 数据标准化器（`data_standardizer.py`）
- 缓存管理器（`cache/` 模块）
- 数据提供器（`providers/` 各子模块）

#### 集成测试
- 数据源降级流程（Tushare → AKShare → Baostock）
- 缓存读写流程（MongoDB + Redis）
- 端到端数据获取（从 API 到 Agent 工具）

#### 场景测试
- 正常交易日的数据获取
- 停牌日期的处理
- 历史日期与当前日期的区分
- 跨年数据获取
- 批量股票数据获取（100+ 只股票）

---

### 已知问题和限制

1. **Tushare 限制**
   - 需要积分才能访问部分接口
   - 高频调用可能导致积分耗尽
   - 建议搭配 MongoDB 缓存使用

2. **AKShare 限制**
   - 基于爬虫，稳定性依赖第三方网站
   - 可能遇到反爬机制
   - 建议作为备选数据源

3. **BaoStock 限制**
   - 数据更新可能延迟
   - 某些指标可能不准确
   - 建议作为最后备选

4. **MongoDB 缓存限制**
   - 首次使用时需要导入数据
   - 缓存数据需要定期更新
   - 建议设置自动更新任务

---

### 评估方法

#### 自动化评估
```bash
# 运行单元测试
python -m pytest tests/unit/dataflows/ -v

# 运行集成测试
python -m pytest tests/integration/dataflows/ -v

# 运行性能测试
python tests/performance/data_source_benchmark.py

# 检查测试覆盖率
python -m pytest --cov=tradingagents/dataflows --cov-report=html
```

#### 手动评估
1. **数据源降级验证**
   - 禁用 Tushare Token，验证是否降级到 AKShare
   - 模拟网络故障，验证错误处理

2. **数据标准化验证**
   - 对比不同数据源的返回值
   - 检查 MongoDB 中的数据单位
   - 验证分析报告中的成交量显示

3. **缓存机制验证**
   - 清空所有缓存，首次调用
   - 第二次调用，检查缓存命中
   - 手动刷新缓存，验证数据更新

4. **性能验证**
   - 批量获取 100 只股票的数据
   - 记录响应时间和内存使用
   - 对比缓存命中/未命中的性能差异

---

### 责任人

- **评估创建**: 2026-02-05
- **评估人**: [待指定]
- **审核人**: [待指定]

---

### 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| 1.0.0 | 2026-02-05 | 初始版本，定义数据源评估标准 |

---

**备注**：此评估定义遵循 TradingAgents-CN 项目的 TDD 开发流程，所有评估项都应有对应的测试用例。
