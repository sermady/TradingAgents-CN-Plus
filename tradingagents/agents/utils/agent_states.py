# -*- coding: utf-8 -*-
from typing import Annotated, List
from datetime import date, timedelta, datetime
from typing_extensions import TypedDict, Optional
from langchain_openai import ChatOpenAI
from tradingagents.agents import *
from langgraph.graph import END, StateGraph, START, MessagesState

# å¯¼å…¥ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
from tradingagents.utils.logging_init import get_logger

logger = get_logger("default")


# Researcher team state
class InvestDebateState(TypedDict):
    bull_history: Annotated[
        str, "Bullish Conversation history"
    ]  # Bullish Conversation history
    bear_history: Annotated[
        str, "Bearish Conversation history"
    ]  # Bullish Conversation history
    history: Annotated[str, "Conversation history"]  # Conversation history
    current_response: Annotated[str, "Latest response"]  # Last response
    judge_decision: Annotated[str, "Final judge decision"]  # Last response
    count: Annotated[int, "Length of the current conversation"]  # Conversation length
    # Phase 2.2: è¯æ®å¼ºåº¦å’Œæ•°æ®å¼•ç”¨è·Ÿè¸ª
    evidence_strength: Annotated[float, "Overall evidence strength (0-1)"]  # è¯æ®å¼ºåº¦è¯„åˆ†
    citations: Annotated[
        list, "List of data citations with source and confidence"
    ]  # æ•°æ®å¼•ç”¨åˆ—è¡¨


# Risk management team state
class RiskDebateState(TypedDict):
    risky_history: Annotated[
        str, "Risky Agent's Conversation history"
    ]  # Conversation history
    safe_history: Annotated[
        str, "Safe Agent's Conversation history"
    ]  # Conversation history
    neutral_history: Annotated[
        str, "Neutral Agent's Conversation history"
    ]  # Conversation history
    history: Annotated[str, "Conversation history"]  # Conversation history
    latest_speaker: Annotated[str, "Analyst that spoke last"]
    current_risky_response: Annotated[
        str, "Latest response by the risky analyst"
    ]  # Last response
    current_safe_response: Annotated[
        str, "Latest response by the safe analyst"
    ]  # Last response
    current_neutral_response: Annotated[
        str, "Latest response by the neutral analyst"
    ]  # Last response
    judge_decision: Annotated[str, "Judge's decision"]
    count: Annotated[int, "Length of the current conversation"]  # Conversation length


class AgentState(MessagesState):
    company_of_interest: Annotated[str, "Company that we are interested in trading"]
    trade_date: Annotated[str, "What date we are trading at"]

    sender: Annotated[str, "Agent that sent this message"]

    # Centralized Data Store (Pre-fetched by DataCoordinator)
    market_data: Annotated[str, "Raw technical analysis data"]
    financial_data: Annotated[str, "Raw fundamental data"]
    news_data: Annotated[str, "Raw aggregated news data"]
    sentiment_data: Annotated[str, "Raw social sentiment data"]
    china_market_data: Annotated[str, "Raw China A-share market features data"]

    # research step
    market_report: Annotated[str, "Report from the Market Analyst"]
    sentiment_report: Annotated[str, "Report from the Social Media Analyst"]
    news_report: Annotated[
        str, "Report from the News Researcher of current world affairs"
    ]
    fundamentals_report: Annotated[str, "Report from the Fundamentals Researcher"]
    china_market_report: Annotated[str, "Report from the China Market Analyst"]

    # ğŸ”§ æ­»å¾ªç¯é˜²æŠ¤: å·¥å…·è°ƒç”¨è®¡æ•°å™¨
    # æ³¨ï¼šè™½ç„¶é‡æ„ååˆ†æå¸ˆä½¿ç”¨ Data Coordinator é¢„å–æ•°æ®ï¼Œä¸å†ç›´æ¥è°ƒç”¨å·¥å…·ï¼Œ
    # ä½†ä¿ç•™è¿™äº›å­—æ®µä½œä¸ºå®‰å…¨é˜²æŠ¤æœºåˆ¶ï¼Œé˜²æ­¢æ„å¤–æƒ…å†µä¸‹çš„æ— é™å¾ªç¯
    # è¿™äº›å­—æ®µç”± conditional_logic.py ä¸­çš„æ­»å¾ªç¯æ£€æµ‹é€»è¾‘ä½¿ç”¨
    market_tool_call_count: Annotated[
        int, "Market analyst tool call counter (safety mechanism)"
    ] = 0
    news_tool_call_count: Annotated[
        int, "News analyst tool call counter (safety mechanism)"
    ] = 0
    sentiment_tool_call_count: Annotated[
        int, "Social media analyst tool call counter (safety mechanism)"
    ] = 0
    fundamentals_tool_call_count: Annotated[
        int, "Fundamentals analyst tool call counter (safety mechanism)"
    ] = 0

    # researcher team discussion step
    investment_debate_state: Annotated[
        InvestDebateState, "Current state of the debate on if to invest or not"
    ]
    investment_plan: Annotated[str, "Plan generated by the Analyst"]

    trader_investment_plan: Annotated[str, "Plan generated by the Trader"]

    # risk management team discussion step
    risk_debate_state: Annotated[
        RiskDebateState, "Current state of the debate on evaluating risk"
    ]
    final_trade_decision: Annotated[str, "Final decision made by the Risk Analysts"]

    # ========== æ•°æ®è´¨é‡é£æ§å­—æ®µ (Phase 1.1/1.4) ==========
    data_quality_score: Annotated[
        float, "Data quality score (0-100)"
    ] = 100.0  # é»˜è®¤æ»¡åˆ†
    data_quality_grade: Annotated[
        str, "Data quality grade (A/B/C/D/F)"
    ] = "A"  # é»˜è®¤Açº§
    data_quality_issues: Annotated[
        List[str], "List of data quality issues"
    ] = []  # é»˜è®¤æ— é—®é¢˜
