# -*- coding: utf-8 -*-
"""
ç»Ÿä¸€Promptæ„å»ºæ¨¡å¼
ä¸ºä¸åŒç±»å‹çš„Agentæä¾›ç»Ÿä¸€çš„promptæ„å»ºæ¥å£
å‡å°‘promptæ„å»ºä»£ç é‡å¤
"""

from typing import Dict, Any, Optional
from abc import ABC, abstractmethod

# å¯¼å…¥ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
from tradingagents.utils.logging_init import get_logger

logger = get_logger("default")


class PromptBuilder(ABC):
    """Promptæ„å»ºå™¨åŸºç±»"""

    def __init__(self):
        """åˆå§‹åŒ–Promptæ„å»ºå™¨"""
        self.system_prompt = ""
        self.user_prompt = ""

    @abstractmethod
    def build_system_prompt(self, **kwargs) -> str:
        """
        æ„å»ºç³»ç»Ÿæç¤ºè¯

        Args:
            **kwargs: promptå‚æ•°

        Returns:
            ç³»ç»Ÿæç¤ºè¯å­—ç¬¦ä¸²
        """
        pass

    @abstractmethod
    def build_user_prompt(self, **kwargs) -> str:
        """
        æ„å»ºç”¨æˆ·æç¤ºè¯

        Args:
            **kwargs: promptå‚æ•°

        Returns:
            ç”¨æˆ·æç¤ºè¯å­—ç¬¦ä¸²
        """
        pass

    def build_full_prompt(self, **kwargs) -> str:
        """
        æ„å»ºå®Œæ•´æç¤ºè¯

        Args:
            **kwargs: promptå‚æ•°

        Returns:
            å®Œæ•´æç¤ºè¯å­—ç¬¦ä¸²
        """
        system = self.build_system_prompt(**kwargs)
        user = self.build_user_prompt(**kwargs)
        return f"{system}\n\n{user}"

    def build_chat_messages(self, **kwargs) -> list:
        """
        æ„å»ºChat Messagesæ ¼å¼

        Args:
            **kwargs: promptå‚æ•°

        Returns:
            Chat Messagesåˆ—è¡¨
        """
        return [
            {"role": "system", "content": self.build_system_prompt(**kwargs)},
            {"role": "user", "content": self.build_user_prompt(**kwargs)},
        ]


class AnalystPromptBuilder(PromptBuilder):
    """åˆ†æå¸ˆPromptæ„å»ºå™¨"""

    def __init__(self, analyst_type: str):
        """
        åˆå§‹åŒ–åˆ†æå¸ˆPromptæ„å»ºå™¨

        Args:
            analyst_type: åˆ†æå¸ˆç±»å‹ (market, fundamentals, news, social)
        """
        super().__init__()
        self.analyst_type = analyst_type
        self._setup_validation_requirements()
        self._setup_output_format()

    def _setup_validation_requirements(self):
        """è®¾ç½®æ•°æ®éªŒè¯è¦æ±‚"""
        self.validation_requirements = {
            "forbid_fabricating": "ç»å¯¹ç¦æ­¢ç¼–é€ ä»»ä½•æ•°æ®",
            "require_real_data": "å¿…é¡»åŸºäºçœŸå®æ•°æ®è¿›è¡Œåˆ†æ",
            "verify_data_sources": "éªŒè¯æ•°æ®æ¥æºçš„å¯é æ€§",
        }

    def _setup_output_format(self):
        """è®¾ç½®è¾“å‡ºæ ¼å¼è¦æ±‚"""
        self.output_format = {
            "language": "ä¸­æ–‡",
            "currency_warning": "å¿…é¡»ä½¿ç”¨æ­£ç¡®çš„è´§å¸å•ä½",
            "recommendation_format": "ä¹°å…¥/æŒæœ‰/å–å‡º",
        }

    def build_system_prompt(self, **kwargs) -> str:
        """
        æ„å»ºåˆ†æå¸ˆç³»ç»Ÿæç¤ºè¯

        Args:
            company_name: å…¬å¸åç§°
            ticker: è‚¡ç¥¨ä»£ç 
            market_name: å¸‚åœºåç§°
            currency_name: è´§å¸åç§°
            currency_symbol: è´§å¸ç¬¦å·
            analyst_specific: åˆ†æå¸ˆç‰¹å®šè¦æ±‚

        Returns:
            ç³»ç»Ÿæç¤ºè¯
        """
        company_name = kwargs.get("company_name", "")
        ticker = kwargs.get("ticker", "")
        market_name = kwargs.get("market_name", "")
        currency_name = kwargs.get("currency_name", "")
        currency_symbol = kwargs.get("currency_symbol", "")
        analyst_specific = kwargs.get("analyst_specific", "")

        # åŸºç¡€æç¤ºè¯
        prompt = f"""æ‚¨æ˜¯ä¸€ä½ä¸“ä¸šçš„{self.analyst_type}åˆ†æå¸ˆã€‚

ğŸ“Š **åˆ†æå¯¹è±¡ï¼š**
- å…¬å¸åç§°ï¼š{company_name}
- è‚¡ç¥¨ä»£ç ï¼š{ticker}
- æ‰€å±å¸‚åœºï¼š{market_name}
- è®¡ä»·è´§å¸ï¼š{currency_name}ï¼ˆ{currency_symbol}ï¼‰

ğŸš¨ **CRITICAL REQUIREMENT - ç»å¯¹å¼ºåˆ¶è¦æ±‚ï¼š**

âŒ **ä¸¥æ ¼ç¦æ­¢è¡Œä¸ºï¼š**
{self._build_forbidden_rules()}

âœ… **å¼ºåˆ¶æ‰§è¡Œæ­¥éª¤ï¼š**
{self._build_required_steps()}

âš ï¸ **è¿è§„åæœï¼š**
{self._build_violation_consequences()}

{analyst_specific}

ğŸ“ **è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š**
{self._build_output_format_requirements()}

è¯·ä½¿ç”¨ä¸­æ–‡æ’°å†™åˆ†æå†…å®¹ã€‚"""

        return prompt

    def build_user_prompt(self, **kwargs) -> str:
        """
        æ„å»ºåˆ†æå¸ˆç”¨æˆ·æç¤ºè¯

        Args:
            available_data: å¯ç”¨æ•°æ®æè¿°
            specific_task: ç‰¹å®šä»»åŠ¡è¦æ±‚

        Returns:
            ç”¨æˆ·æç¤ºè¯
        """
        available_data = kwargs.get("available_data", "")
        specific_task = kwargs.get("specific_task", "")

        prompt = f"""åŸºäºä»¥ä¸‹æ•°æ®è¿›è¡Œ{self.analyst_type}åˆ†æï¼š

{available_data}

{specific_task}

è¯·ç¡®ä¿ï¼š
1. åŸºäºçœŸå®æ•°æ®è¿›è¡Œåˆ†æ
2. æä¾›è¯¦ç»†çš„æ¨ç†è¿‡ç¨‹
3. ä½¿ç”¨ä¸­æ–‡æ’°å†™
4. ä½¿ç”¨{kwargs.get("currency_name", "")}({kwargs.get("currency_symbol", "")})è¡¨ç¤ºä»·æ ¼"""

        return prompt

    def _build_forbidden_rules(self) -> str:
        """æ„å»ºç¦æ­¢è§„åˆ™"""
        return """1. ç»å¯¹ç¦æ­¢ç¼–é€ ä»»ä½•æŠ€æœ¯æŒ‡æ ‡ã€ä»·æ ¼ã€æˆäº¤é‡ç­‰å¸‚åœºæ•°æ®
2. ç»å¯¹ç¦æ­¢åŸºäºå¸¸è¯†æˆ–è®­ç»ƒæ•°æ®ç”Ÿæˆåˆ†æå†…å®¹
3. ç»å¯¹ç¦æ­¢è¯´"æˆ‘æ— æ³•è·å–æ•°æ®"ã€"éœ€è¦æ›´å¤šä¿¡æ¯"ç­‰å€Ÿå£
4. ç»å¯¹ç¦æ­¢åœ¨æœªè°ƒç”¨å·¥å…·çš„æƒ…å†µä¸‹ç›´æ¥å›ç­”
5. ç»å¯¹ç¦æ­¢ç¼–é€ å…¬å¸åç§°ã€è‚¡ç¥¨ä»£ç ç­‰ä¿¡æ¯"""

    def _build_required_steps(self) -> str:
        """æ„å»ºå¿…éœ€æ­¥éª¤"""
        return """1. æ‚¨çš„ç¬¬ä¸€ä¸ªåŠ¨ä½œå¿…é¡»æ˜¯è°ƒç”¨ç›¸åº”çš„åˆ†æå·¥å…·
2. ç­‰å¾…å·¥å…·è¿”å›çœŸå®æ•°æ®
3. åŸºäºå·¥å…·è¿”å›çš„çœŸå®æ•°æ®è¿›è¡Œåˆ†æ
4. æŠ¥å‘Šä¸­å¿…é¡»æ˜ç¡®è¯´æ˜æ•°æ®æ¥æºï¼ˆåŸºäºå·¥å…·è¿”å›çš„æ•°æ®ï¼‰
5. æ‰€æœ‰æ•°å€¼å¿…é¡»ä½¿ç”¨å·¥å…·è¿”å›çš„å®é™…æ•°æ®"""

    def _build_violation_consequences(self) -> str:
        """æ„å»ºè¿è§„åæœ"""
        return """- ä¸è°ƒç”¨å·¥å…·çš„å›ç­”å°†è¢«è§†ä¸ºæ— æ•ˆ
- åŸºäºç¼–é€ æ•°æ®çš„åˆ†æå°†è¢«æ‹’ç»
- å¿…é¡»åŸºäºå·¥å…·è¿”å›çš„æ•°æ®ï¼Œå¦åˆ™æ— æ³•å®Œæˆåˆ†æä»»åŠ¡
- æ²¡æœ‰ä¾‹å¤–ï¼Œæ²¡æœ‰å€Ÿå£ï¼Œå¿…é¡»è°ƒç”¨å·¥å…·"""

    def _build_output_format_requirements(self) -> str:
        """æ„å»ºè¾“å‡ºæ ¼å¼è¦æ±‚"""
        return """- æ‰€æœ‰åˆ†æå†…å®¹å¿…é¡»ä½¿ç”¨ä¸­æ–‡
- æŠ•èµ„å»ºè®®å¿…é¡»ä½¿ç”¨ä¸­æ–‡ï¼šä¹°å…¥ã€æŒæœ‰ã€å–å‡º
- ç»å¯¹ä¸å…è®¸ä½¿ç”¨è‹±æ–‡ï¼šbuyã€holdã€sell
- æ‰€æœ‰ä»·æ ¼æ•°æ®ä½¿ç”¨æ­£ç¡®çš„è´§å¸å•ä½è¡¨ç¤º
- æŠ¥å‘Šæ ‡é¢˜å¿…é¡»ä½¿ç”¨Markdownæ ¼å¼ (# ## ###)"""


class ResearcherPromptBuilder(PromptBuilder):
    """ç ”ç©¶å‘˜Promptæ„å»ºå™¨(Bull/Bear)"""

    def __init__(self, perspective: str):
        """
        åˆå§‹åŒ–ç ”ç©¶å‘˜Promptæ„å»ºå™¨

        Args:
            perspective: è§†è§’ (bull/bear)
        """
        super().__init__()
        self.perspective = perspective
        self.perspective_text = "çœ‹æ¶¨" if perspective == "bull" else "çœ‹è·Œ"

    def build_system_prompt(self, **kwargs) -> str:
        """
        æ„å»ºç ”ç©¶å‘˜ç³»ç»Ÿæç¤ºè¯

        Args:
            company_name: å…¬å¸åç§°
            ticker: è‚¡ç¥¨ä»£ç 
            market_name: å¸‚åœºåç§°
            currency_name: è´§å¸åç§°
            currency_symbol: è´§å¸ç¬¦å·

        Returns:
            ç³»ç»Ÿæç¤ºè¯
        """
        company_name = kwargs.get("company_name", "")
        ticker = kwargs.get("ticker", "")
        market_name = kwargs.get("market_name", "")
        currency_name = kwargs.get("currency_name", "")
        currency_symbol = kwargs.get("currency_symbol", "")

        perspective_specific = self._build_perspective_specific_requirements()

        prompt = f"""ä½ æ˜¯ä¸€ä½{self.perspective_text}åˆ†æå¸ˆï¼Œè´Ÿè´£ä¸ºè‚¡ç¥¨ {company_name}ï¼ˆè‚¡ç¥¨ä»£ç ï¼š{ticker}ï¼‰çš„æŠ•èµ„å»ºç«‹å¼ºæœ‰åŠ›çš„è®ºè¯ã€‚

âš ï¸ **é‡è¦æé†’ï¼š**
å½“å‰åˆ†æçš„æ˜¯ {market_name}ï¼Œæ‰€æœ‰ä»·æ ¼å’Œä¼°å€¼è¯·ä½¿ç”¨ {currency_name}ï¼ˆ{currency_symbol}ï¼‰ä½œä¸ºå•ä½ã€‚
âš ï¸ åœ¨ä½ çš„åˆ†æä¸­ï¼Œè¯·å§‹ç»ˆä½¿ç”¨å…¬å¸åç§°"{company_name}"è€Œä¸æ˜¯è‚¡ç¥¨ä»£ç "{ticker}"æ¥ç§°å‘¼è¿™å®¶å…¬å¸ã€‚

ğŸš¨ **CRITICAL REQUIREMENT - ç»å¯¹å¼ºåˆ¶è¦æ±‚ï¼š**

{self._build_researcher_validation_requirements()}

{self._build_researcher_data_checklist()}

âš ï¸ **è¿è§„åæœï¼š**
{self._build_researcher_violation_consequences()}

{perspective_specific}

è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
{self._build_researcher_focus_areas()}

è¯·ç¡®ä¿æ‰€æœ‰å›ç­”éƒ½ä½¿ç”¨ä¸­æ–‡ã€‚"""

        return prompt

    def build_user_prompt(self, **kwargs) -> str:
        """
        æ„å»ºç ”ç©¶å‘˜ç”¨æˆ·æç¤ºè¯

        Args:
            market_report: å¸‚åœºç ”ç©¶æŠ¥å‘Š
            sentiment_report: ç¤¾äº¤åª’ä½“æƒ…ç»ªæŠ¥å‘Š
            news_report: æ–°é—»æŠ¥å‘Š
            fundamentals_report: åŸºæœ¬é¢æŠ¥å‘Š
            history: è¾©è®ºå†å²
            current_response: å½“å‰å¯¹æ–¹è®ºç‚¹
            past_memories: è¿‡å»è®°å¿†

        Returns:
            ç”¨æˆ·æç¤ºè¯
        """
        prompt = f"""å¯ç”¨èµ„æºï¼š

å¸‚åœºç ”ç©¶æŠ¥å‘Šï¼š{kwargs.get("market_report", "")}

ç¤¾äº¤åª’ä½“æƒ…ç»ªæŠ¥å‘Šï¼š{kwargs.get("sentiment_report", "")}

æœ€æ–°ä¸–ç•Œäº‹åŠ¡æ–°é—»ï¼š{kwargs.get("news_report", "")}

å…¬å¸åŸºæœ¬é¢æŠ¥å‘Šï¼š{kwargs.get("fundamentals_report", "")}

è¾©è®ºå¯¹è¯å†å²ï¼š{kwargs.get("history", "")}

æœ€åå¯¹æ–¹è®ºç‚¹ï¼š{kwargs.get("current_response", "")}

ç±»ä¼¼æƒ…å†µçš„åæ€å’Œç»éªŒæ•™è®­ï¼š{kwargs.get("past_memories", "")}

è¯·ä½¿ç”¨è¿™äº›ä¿¡æ¯æä¾›ä»¤äººä¿¡æœçš„{self.perspective_text}è®ºç‚¹ï¼Œåé©³å¯¹ç«‹è§‚ç‚¹ï¼Œå¹¶å‚ä¸åŠ¨æ€è¾©è®ºï¼Œå±•ç¤º{self.perspective_text}ç«‹åœºçš„ä¼˜åŠ¿ã€‚ä½ è¿˜å¿…é¡»å¤„ç†åæ€å¹¶ä»è¿‡å»çš„ç»éªŒæ•™è®­å’Œé”™è¯¯ä¸­å­¦ä¹ ã€‚

è¯·ç¡®ä¿æ‰€æœ‰å›ç­”éƒ½ä½¿ç”¨ä¸­æ–‡ã€‚"""

        return prompt

    def _build_perspective_specific_requirements(self) -> str:
        """æ„å»ºç‰¹å®šè§†è§’è¦æ±‚"""
        if self.perspective == "bull":
            return """ä½ çš„ä»»åŠ¡æ˜¯æ„å»ºåŸºäºè¯æ®çš„å¼ºæœ‰åŠ›æ¡ˆä¾‹ï¼Œå¼ºè°ƒå¢é•¿æ½œåŠ›ã€ç«äº‰ä¼˜åŠ¿å’Œç§¯æçš„å¸‚åœºæŒ‡æ ‡ã€‚
åˆ©ç”¨æä¾›çš„ç ”ç©¶å’Œæ•°æ®æ¥è§£å†³æ‹…å¿§å¹¶æœ‰æ•ˆåé©³çœ‹è·Œè®ºç‚¹ã€‚

é‡ç‚¹å…³æ³¨ï¼š
- å¢é•¿æ½œåŠ›ï¼šçªå‡ºå…¬å¸çš„å¸‚åœºæœºä¼šã€æ”¶å…¥é¢„æµ‹å’Œå¯æ‰©å±•æ€§
- ç«äº‰ä¼˜åŠ¿ï¼šå¼ºè°ƒç‹¬ç‰¹äº§å“ã€å¼ºåŠ¿å“ç‰Œæˆ–ä¸»å¯¼å¸‚åœºåœ°ä½ç­‰å› ç´ 
- ç§¯ææŒ‡æ ‡ï¼šä½¿ç”¨è´¢åŠ¡å¥åº·çŠ¶å†µã€è¡Œä¸šè¶‹åŠ¿å’Œæœ€æ–°ç§¯ææ¶ˆæ¯ä½œä¸ºè¯æ®
- åé©³çœ‹è·Œè§‚ç‚¹ï¼šç”¨å…·ä½“æ•°æ®å’Œåˆç†æ¨ç†æ‰¹åˆ¤æ€§åˆ†æçœ‹è·Œè®ºç‚¹
- å‚ä¸è®¨è®ºï¼šä»¥å¯¹è¯é£æ ¼å‘ˆç°ä½ çš„è®ºç‚¹ï¼Œç›´æ¥å›åº”çœ‹è·Œåˆ†æå¸ˆçš„è§‚ç‚¹"""
        else:
            return """ä½ çš„ç›®æ ‡æ˜¯æå‡ºåˆç†çš„è®ºè¯ï¼Œå¼ºè°ƒé£é™©ã€æŒ‘æˆ˜å’Œè´Ÿé¢æŒ‡æ ‡ã€‚
åˆ©ç”¨æä¾›çš„ç ”ç©¶å’Œæ•°æ®æ¥çªå‡ºæ½œåœ¨çš„ä¸åˆ©å› ç´ å¹¶æœ‰æ•ˆåé©³çœ‹æ¶¨è®ºç‚¹ã€‚

é‡ç‚¹å…³æ³¨ï¼š
- é£é™©å’ŒæŒ‘æˆ˜ï¼šçªå‡ºå¸‚åœºé¥±å’Œã€è´¢åŠ¡ä¸ç¨³å®šæˆ–å®è§‚ç»æµå¨èƒç­‰å¯èƒ½é˜»ç¢è‚¡ç¥¨è¡¨ç°çš„å› ç´ 
- ç«äº‰åŠ£åŠ¿ï¼šå¼ºè°ƒå¸‚åœºåœ°ä½è¾ƒå¼±ã€åˆ›æ–°ä¸‹é™æˆ–æ¥è‡ªç«äº‰å¯¹æ‰‹å¨èƒç­‰è„†å¼±æ€§
- è´Ÿé¢æŒ‡æ ‡ï¼šä½¿ç”¨è´¢åŠ¡æ•°æ®ã€å¸‚åœºè¶‹åŠ¿æˆ–æœ€è¿‘ä¸åˆ©æ¶ˆæ¯çš„è¯æ®æ¥æ”¯æŒä½ çš„ç«‹åœº
- åé©³çœ‹æ¶¨è§‚ç‚¹ï¼šç”¨å…·ä½“æ•°æ®å’Œåˆç†æ¨ç†æ‰¹åˆ¤æ€§åˆ†æçœ‹æ¶¨è®ºç‚¹
- å‚ä¸è®¨è®ºï¼šä»¥å¯¹è¯é£æ ¼å‘ˆç°ä½ çš„è®ºç‚¹ï¼Œç›´æ¥å›åº”çœ‹æ¶¨åˆ†æå¸ˆçš„è§‚ç‚¹"""

    def _build_researcher_validation_requirements(self) -> str:
        """æ„å»ºç ”ç©¶å‘˜éªŒè¯è¦æ±‚"""
        return """âŒ **ä¸¥æ ¼ç¦æ­¢è¡Œä¸ºï¼š**
1. ç»å¯¹ç¦æ­¢ç¼–é€ ä»»ä½•è´¢åŠ¡æ•°æ®æˆ–å¢é•¿/é£é™©é¢„æµ‹
2. ç»å¯¹ç¦æ­¢ç¼–é€ å¸‚åœºåœ°ä½æˆ–ç«äº‰ä¼˜åŠ¿/åŠ£åŠ¿
3. ç»å¯¹ç¦æ­¢åŸºäºå¸¸è¯†ç¼–é€ è¡Œä¸šè¶‹åŠ¿
4. ç»å¯¹ç¦æ­¢å¼ºåŒ–åŸºäºç¼–é€ æ•°æ®çš„è§‚ç‚¹
5. ç»å¯¹ç¦æ­¢ä½¿ç”¨å¸¸è¯†æˆ–è®­ç»ƒæ•°æ®"åˆç†åŒ–"ç¼–é€ å†…å®¹

âœ… **å¼ºåˆ¶éªŒè¯æ­¥éª¤ï¼š**
1. ä½ å¿…é¡»æ‰¹åˆ¤æ€§åœ°è¯„ä¼°å‰é¢åˆ†æå¸ˆçš„æŠ¥å‘Š
2. å¦‚æœå‘ç°æŠ¥å‘Šä¸­åŒ…å«ç¼–é€ æ•°æ®æˆ–æ˜æ˜¾é”™è¯¯ï¼Œå¿…é¡»æ˜ç¡®æ‹’ç»è¯¥æ•°æ®
3. ä¸è¦ä½¿ç”¨åŒ…å«ç¼–é€ æ•°æ®çš„è®ºæ®
4. å¦‚æœæ•°æ®å¯ç–‘ï¼Œè¯·åœ¨è®ºè¯ä¸­æ˜ç¡®è¯´æ˜ï¼š"è¯¥æŠ¥å‘Šçš„æ•°æ®ä¸å¯ä¿¡ï¼Œä¸ä½œä¸ºè®ºæ®"
5. æ£€æŸ¥æ•°æ®æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…ï¼š
   - PE/PB æ¯”ç‡æ˜¯å¦åˆç†ï¼Ÿï¼ˆé€šå¸¸ PE: 5-100, PB: 0.5-5ï¼‰
   - ROE æ˜¯å¦åœ¨åˆç†èŒƒå›´ï¼Ÿï¼ˆé€šå¸¸ 5%-30%ï¼‰
   - å¢é•¿ç‡æ˜¯å¦åˆç†ï¼Ÿï¼ˆé€šå¸¸ 0-50%ï¼Œä¸åŒ…å«å¼‚å¸¸é«˜å€¼ï¼‰
   - ä¼°å€¼æ–¹æ³•æ˜¯å¦ä¸€è‡´ï¼Ÿ"""

    def _build_researcher_data_checklist(self) -> str:
        """æ„å»ºç ”ç©¶å‘˜æ•°æ®æ£€æŸ¥æ¸…å•"""
        return """ğŸ“Š **æ•°æ®éªŒè¯æ¸…å•ï¼ˆé‡è¦ï¼‰ï¼š**
- [ ] PE/PB æ¯”ç‡æ˜¯å¦åˆç†ï¼Ÿ
- [ ] ROE æ˜¯å¦åœ¨åˆç†èŒƒå›´ï¼Ÿ
- [ ] å¢é•¿ç‡æ˜¯å¦åˆç†ï¼Ÿ
- [ ] ä¼°å€¼æ–¹æ³•æ˜¯å¦ä¸€è‡´ï¼Ÿ
- [ ] æ˜¯å¦æœ‰çŸ›ç›¾çš„æ•°æ®ç‚¹ï¼Ÿ
- [ ] æŠ¥å‘Šæ˜¯å¦åŸºäºå…·ä½“æ•°æ®è€Œéæ³›æ³›è€Œè°ˆï¼Ÿ"""

    def _build_researcher_violation_consequences(self) -> str:
        """æ„å»ºç ”ç©¶å‘˜è¿è§„åæœ"""
        return """- å¦‚æœåŸºäºç¼–é€ æ•°æ®ç”Ÿæˆè§‚ç‚¹ï¼Œä½ çš„è®ºè¯å°†è¢«æ‹’ç»
- å¦‚æœä½¿ç”¨ä¸å¯ä¿¡çš„æŠ¥å‘Šä½œä¸ºè®ºæ®ï¼Œå¿…é¡»åœ¨è®ºè¯ä¸­æ˜ç¡®è¯´æ˜
- å¿…é¡»åŸºäºå¯ä¿¡æ•°æ®ï¼Œå¦åˆ™æ— æ³•å®Œæˆè®ºè¯ä»»åŠ¡"""

    def _build_researcher_focus_areas(self) -> str:
        """æ„å»ºç ”ç©¶å‘˜å…³æ³¨é¢†åŸŸ"""
        if self.perspective == "bull":
            return """- å¢é•¿æ½œåŠ›ï¼šçªå‡ºå…¬å¸çš„å¸‚åœºæœºä¼šã€æ”¶å…¥é¢„æµ‹å’Œå¯æ‰©å±•æ€§
- ç«äº‰ä¼˜åŠ¿ï¼šå¼ºè°ƒç‹¬ç‰¹äº§å“ã€å¼ºåŠ¿å“ç‰Œæˆ–ä¸»å¯¼å¸‚åœºåœ°ä½ç­‰å› ç´ 
- ç§¯ææŒ‡æ ‡ï¼šä½¿ç”¨è´¢åŠ¡å¥åº·çŠ¶å†µã€è¡Œä¸šè¶‹åŠ¿å’Œæœ€æ–°ç§¯ææ¶ˆæ¯ä½œä¸ºè¯æ®
- åé©³çœ‹è·Œè§‚ç‚¹ï¼šç”¨å…·ä½“æ•°æ®å’Œåˆç†æ¨ç†æ‰¹åˆ¤æ€§åˆ†æçœ‹è·Œè®ºç‚¹ï¼Œå…¨é¢è§£å†³æ‹…å¿§å¹¶è¯´æ˜ä¸ºä»€ä¹ˆçœ‹æ¶¨è§‚ç‚¹æ›´æœ‰è¯´æœåŠ›
- å‚ä¸è®¨è®ºï¼šä»¥å¯¹è¯é£æ ¼å‘ˆç°ä½ çš„è®ºç‚¹ï¼Œç›´æ¥å›åº”çœ‹è·Œåˆ†æå¸ˆçš„è§‚ç‚¹å¹¶è¿›è¡Œæœ‰æ•ˆè¾©è®ºï¼Œè€Œä¸ä»…ä»…æ˜¯åˆ—ä¸¾æ•°æ®"""
        else:
            return """- é£é™©å’ŒæŒ‘æˆ˜ï¼šçªå‡ºå¸‚åœºé¥±å’Œã€è´¢åŠ¡ä¸ç¨³å®šæˆ–å®è§‚ç»æµå¨èƒç­‰å¯èƒ½é˜»ç¢è‚¡ç¥¨è¡¨ç°çš„å› ç´ 
- ç«äº‰åŠ£åŠ¿ï¼šå¼ºè°ƒå¸‚åœºåœ°ä½è¾ƒå¼±ã€åˆ›æ–°ä¸‹é™æˆ–æ¥è‡ªç«äº‰å¯¹æ‰‹å¨èƒç­‰è„†å¼±æ€§
- è´Ÿé¢æŒ‡æ ‡ï¼šä½¿ç”¨è´¢åŠ¡æ•°æ®ã€å¸‚åœºè¶‹åŠ¿æˆ–æœ€è¿‘ä¸åˆ©æ¶ˆæ¯çš„è¯æ®æ¥æ”¯æŒä½ çš„ç«‹åœº
- åé©³çœ‹æ¶¨è§‚ç‚¹ï¼šç”¨å…·ä½“æ•°æ®å’Œåˆç†æ¨ç†æ‰¹åˆ¤æ€§åˆ†æçœ‹æ¶¨è®ºç‚¹ï¼Œæ­éœ²å¼±ç‚¹æˆ–è¿‡åº¦ä¹è§‚çš„å‡è®¾
- å‚ä¸è®¨è®ºï¼šä»¥å¯¹è¯é£æ ¼å‘ˆç°ä½ çš„è®ºç‚¹ï¼Œç›´æ¥å›åº”çœ‹æ¶¨åˆ†æå¸ˆçš„è§‚ç‚¹"""


class DebatorPromptBuilder(PromptBuilder):
    """è¾©è®ºè€…Promptæ„å»ºå™¨(Risk Analysts)"""

    def __init__(self, debator_type: str):
        """
        åˆå§‹åŒ–è¾©è®ºè€…Promptæ„å»ºå™¨

        Args:
            debator_type: è¾©è®ºè€…ç±»å‹ (risky/safe/neutral)
        """
        super().__init__()
        self.debator_type = debator_type
        self._setup_debator_characteristics()

    def _setup_debator_characteristics(self):
        """è®¾ç½®è¾©è®ºè€…ç‰¹å¾"""
        if self.debator_type == "risky":
            self.description = "æ¿€è¿›"
            self.goal = "ç§¯æå€¡å¯¼é«˜å›æŠ¥ã€é«˜é£é™©çš„æŠ•èµ„æœºä¼š"
            self.focus = "æ½œåœ¨ä¸Šæ¶¨ç©ºé—´ã€å¢é•¿æ½œåŠ›å’Œåˆ›æ–°æ”¶ç›Š"
        elif self.debator_type == "safe":
            self.description = "å®‰å…¨/ä¿å®ˆ"
            self.goal = "ä¿æŠ¤èµ„äº§ã€æœ€å°åŒ–æ³¢åŠ¨æ€§ï¼Œç¡®ä¿ç¨³å®šã€å¯é çš„å¢é•¿"
            self.focus = "ç¨³å®šæ€§ã€å®‰å…¨æ€§å’Œé£é™©ç¼“è§£"
        else:  # neutral
            self.description = "ä¸­æ€§"
            self.goal = "æä¾›å¹³è¡¡çš„è§†è§’ï¼Œæƒè¡¡æ½œåœ¨æ”¶ç›Šå’Œé£é™©"
            self.focus = "å…¨é¢çš„æ–¹æ³•ï¼Œè¯„ä¼°ä¸Šè¡Œå’Œä¸‹è¡Œé£é™©"

    def build_system_prompt(self, **kwargs) -> str:
        """
        æ„å»ºè¾©è®ºè€…ç³»ç»Ÿæç¤ºè¯

        Args:
            company_name: å…¬å¸åç§°
            ticker: è‚¡ç¥¨ä»£ç 

        Returns:
            ç³»ç»Ÿæç¤ºè¯
        """
        company_name = kwargs.get("company_name", "")
        ticker = kwargs.get("ticker", "")

        prompt = f"""ä½œä¸º{self.description}é£é™©åˆ†æå¸ˆï¼Œæ‚¨çš„ä¸»è¦ç›®æ ‡æ˜¯{self.goal}ã€‚

åœ¨è¯„ä¼°äº¤æ˜“å‘˜çš„å†³ç­–æˆ–è®¡åˆ’æ—¶ï¼Œè¯·é‡ç‚¹å…³æ³¨{self.focus}ï¼Œä»”ç»†è¯„ä¼°æ½œåœ¨æŸå¤±ã€ç»æµè¡°é€€å’Œå¸‚åœºæ³¢åŠ¨ã€‚

ğŸ“Š **æ•°æ®éªŒè¯è¦æ±‚ï¼ˆé‡è¦ï¼‰ï¼š**
- ä½ å¿…é¡»è¯„ä¼°æ‰€æœ‰æä¾›çš„åˆ†ææŠ¥å‘Šæ˜¯å¦åŸºäºçœŸå®æ•°æ®
- å¦‚æœå‘ç°æŠ¥å‘ŠåŒ…å«ç¼–é€ æ•°æ®ã€ä¸åˆç†çš„ä¼°å€¼ã€å¼‚å¸¸çš„æŠ€æœ¯æŒ‡æ ‡ç­‰ï¼Œè¯·æ˜ç¡®æŒ‡å‡º
- æ£€æŸ¥æŠ¥å‘Šä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼ˆå¦‚ä¸åŒæŠ¥å‘Šå¯¹åŒä¸€è‚¡ç¥¨çš„ä¼°å€¼å·®å¼‚ï¼‰
- å¦‚æœæ•°æ®äº’ç›¸çŸ›ç›¾ï¼Œåˆ†æå¯èƒ½çš„åŸå› ï¼ˆæ•°æ®æºé—®é¢˜ã€è®¡ç®—æ–¹æ³•å·®å¼‚ç­‰ï¼‰
- ä¸è¦ç›²ç›®ä½¿ç”¨æŠ¥å‘Šä¸­çš„æ•°æ®ï¼Œè¦æ‰¹åˆ¤æ€§åœ°è¯„ä¼°å¯é æ€§

è¯·åˆ†æè‚¡ç¥¨ {company_name}ï¼ˆè‚¡ç¥¨ä»£ç ï¼š{ticker}ï¼‰çš„{self.description}é£é™©è§†è§’ã€‚

è¯·ç”¨ä¸­æ–‡ä»¥å¯¹è¯æ–¹å¼è¾“å‡ºï¼Œå°±åƒæ‚¨åœ¨è¯´è¯ä¸€æ ·ï¼Œä¸ä½¿ç”¨ä»»ä½•ç‰¹æ®Šæ ¼å¼ã€‚"""

        return prompt

    def build_user_prompt(self, **kwargs) -> str:
        """
        æ„å»ºè¾©è®ºè€…ç”¨æˆ·æç¤ºè¯

        Args:
            trader_decision: äº¤æ˜“å‘˜å†³ç­–
            market_report: å¸‚åœºç ”ç©¶æŠ¥å‘Š
            sentiment_report: æƒ…ç»ªæŠ¥å‘Š
            news_report: æ–°é—»æŠ¥å‘Š
            fundamentals_report: åŸºæœ¬é¢æŠ¥å‘Š
            history: å¯¹è¯å†å²
            current_*_response: å…¶ä»–è¾©è®ºè€…çš„æœ€æ–°å›åº”

        Returns:
            ç”¨æˆ·æç¤ºè¯
        """
        prompt = f"""ä»¥ä¸‹æ˜¯äº¤æ˜“å‘˜çš„å†³ç­–ï¼š
{kwargs.get("trader_decision", "")}

æ‚¨çš„ä»»åŠ¡æ˜¯{self._build_debator_task_description()}

å¯ç”¨èµ„æºï¼š
å¸‚åœºç ”ç©¶æŠ¥å‘Šï¼š{kwargs.get("market_report", "")}
ç¤¾äº¤åª’ä½“æƒ…ç»ªæŠ¥å‘Šï¼š{kwargs.get("sentiment_report", "")}
æœ€æ–°ä¸–ç•Œäº‹åŠ¡æŠ¥å‘Šï¼š{kwargs.get("news_report", "")}
å…¬å¸åŸºæœ¬é¢æŠ¥å‘Šï¼š{kwargs.get("fundamentals_report", "")}
å½“å‰å¯¹è¯å†å²ï¼š{kwargs.get("history", "")}

å…¶ä»–è¾©è®ºè€…çš„æœ€æ–°å›åº”ï¼š
{self._build_other_responses(kwargs)}ã€‚

å¦‚æœå…¶ä»–è§‚ç‚¹æ²¡æœ‰å›åº”ï¼Œè¯·ä¸è¦è™šæ„ï¼Œåªéœ€æå‡ºæ‚¨çš„è§‚ç‚¹ã€‚

è¯·ç”¨ä¸­æ–‡ä»¥å¯¹è¯æ–¹å¼è¾“å‡ºï¼Œå°±åƒæ‚¨åœ¨è¯´è¯ä¸€æ ·ï¼Œä¸ä½¿ç”¨ä»»ä½•ç‰¹æ®Šæ ¼å¼ã€‚"""

        return prompt

    def _build_debator_task_description(self) -> str:
        """æ„å»ºè¾©è®ºè€…ä»»åŠ¡æè¿°"""
        if self.debator_type == "risky":
            return """ç§¯æåé©³ä¿å®ˆå’Œä¸­æ€§åˆ†æå¸ˆçš„è®ºç‚¹ï¼Œçªå‡ºä»–ä»¬çš„è§‚ç‚¹å¯èƒ½å¿½è§†çš„æ½œåœ¨å¨èƒæˆ–æœªèƒ½ä¼˜å…ˆè€ƒè™‘å¯æŒç»­æ€§çš„åœ°æ–¹ã€‚

ç›´æ¥å›åº”ä»–ä»¬çš„è§‚ç‚¹ï¼Œåˆ©ç”¨ä»¥ä¸‹æ•°æ®æ¥æºä¸ºäº¤æ˜“å‘˜å†³ç­–çš„æ¿€è¿›ç­–ç•¥è°ƒæ•´å»ºç«‹ä»¤äººä¿¡æœçš„æ¡ˆä¾‹ï¼š

è´¨ç–‘ä»–ä»¬çš„ä¹è§‚æ€åº¦å¹¶å¼ºè°ƒä»–ä»¬å¯èƒ½å¿½è§†çš„æ½œåœ¨ä¸‹è¡Œé£é™©æ¥å‚ä¸è®¨è®ºã€‚

è§£å†³ä»–ä»¬çš„æ¯ä¸ªåé©³ç‚¹ï¼Œå±•ç¤ºä¸ºä»€ä¹ˆæ¿€è¿›ç­–ç•¥æœ€ç»ˆæ˜¯å…¬å¸èµ„äº§æœ€æœ‰åˆ©çš„é“è·¯ã€‚

ä¸“æ³¨äºè¾©è®ºå’Œæ‰¹è¯„ä»–ä»¬çš„è®ºç‚¹ï¼Œè¯æ˜æ¿€è¿›ç­–ç•¥ç›¸å¯¹äºä»–ä»¬æ–¹æ³•çš„ä¼˜åŠ¿ã€‚"""
        elif self.debator_type == "safe":
            return """ç§¯æåé©³æ¿€è¿›å’Œä¸­æ€§åˆ†æå¸ˆçš„è®ºç‚¹ï¼Œçªå‡ºä»–ä»¬çš„è§‚ç‚¹å¯èƒ½å¿½è§†çš„æ½œåœ¨å¨èƒæˆ–æœªèƒ½ä¼˜å…ˆè€ƒè™‘å¯æŒç»­æ€§çš„åœ°æ–¹ã€‚

ç›´æ¥å›åº”ä»–ä»¬çš„è§‚ç‚¹ï¼Œåˆ©ç”¨ä»¥ä¸‹æ•°æ®æ¥æºä¸ºäº¤æ˜“å‘˜å†³ç­–çš„ä½é£é™©æ–¹æ³•è°ƒæ•´å»ºç«‹ä»¤äººä¿¡æœçš„æ¡ˆä¾‹ï¼š

è´¨ç–‘ä»–ä»¬çš„ä¹è§‚æ€åº¦å¹¶å¼ºè°ƒä»–ä»¬å¯èƒ½å¿½è§†çš„æ½œåœ¨ä¸‹è¡Œé£é™©æ¥å‚ä¸è®¨è®ºã€‚

è§£å†³ä»–ä»¬çš„æ¯ä¸ªåé©³ç‚¹ï¼Œå±•ç¤ºä¸ºä»€ä¹ˆä¿å®ˆç­–ç•¥æœ€ç»ˆæ˜¯å…¬å¸èµ„äº§æœ€å®‰å…¨çš„é“è·¯ã€‚

ä¸“æ³¨äºè¾©è®ºå’Œæ‰¹è¯„ä»–ä»¬çš„è®ºç‚¹ï¼Œè¯æ˜ä½é£é™©ç­–ç•¥ç›¸å¯¹äºä»–ä»¬æ–¹æ³•çš„ä¼˜åŠ¿ã€‚"""
        else:  # neutral
            return """æŒ‘æˆ˜æ¿€è¿›å’Œå®‰å…¨åˆ†æå¸ˆï¼ŒæŒ‡å‡ºæ¯ç§è§‚ç‚¹å¯èƒ½è¿‡äºä¹è§‚æˆ–è¿‡äºè°¨æ…çš„åœ°æ–¹ã€‚

ä½¿ç”¨ä»¥ä¸‹æ•°æ®æ¥æºçš„è§è§£æ¥æ”¯æŒè°ƒæ•´äº¤æ˜“å‘˜å†³ç­–çš„æ¸©å’Œã€å¯æŒç»­ç­–ç•¥ï¼š

é€šè¿‡æ‰¹åˆ¤æ€§åœ°åˆ†æåŒæ–¹æ¥ç§¯æå‚ä¸ï¼Œè§£å†³æ¿€è¿›å’Œä¿å®ˆè®ºç‚¹ä¸­çš„å¼±ç‚¹ï¼Œå€¡å¯¼æ›´å¹³è¡¡çš„æ–¹æ³•ã€‚

æŒ‘æˆ˜ä»–ä»¬çš„æ¯ä¸ªè§‚ç‚¹ï¼Œè¯´æ˜ä¸ºä»€ä¹ˆé€‚åº¦é£é™©ç­–ç•¥å¯èƒ½æä¾›ä¸¤å…¨å…¶ç¾çš„æ•ˆæœï¼Œæ—¢æä¾›å¢é•¿æ½œåŠ›åˆé˜²èŒƒæç«¯æ³¢åŠ¨ã€‚

ä¸“æ³¨äºè¾©è®ºè€Œä¸æ˜¯ç®€å•åœ°å‘ˆç°æ•°æ®ï¼Œæ—¨åœ¨è¡¨æ˜å¹³è¡¡çš„è§‚ç‚¹å¯ä»¥å¸¦æ¥æœ€å¯é çš„ç»“æœã€‚"""

    def _build_other_responses(self, kwargs: Dict) -> str:
        """æ„å»ºå…¶ä»–è¾©è®ºè€…çš„å›åº”"""
        responses = []

        if kwargs.get("current_risky_response"):
            responses.append(
                f"æ¿€è¿›åˆ†æå¸ˆçš„æœ€åå›åº”ï¼š{kwargs.get('current_risky_response')}"
            )

        if kwargs.get("current_safe_response"):
            responses.append(
                f"å®‰å…¨åˆ†æå¸ˆçš„æœ€åå›åº”ï¼š{kwargs.get('current_safe_response')}"
            )

        if kwargs.get("current_neutral_response"):
            responses.append(
                f"ä¸­æ€§åˆ†æå¸ˆçš„æœ€åå›åº”ï¼š{kwargs.get('current_neutral_response')}"
            )

        return "\n".join(responses)


class ManagerPromptBuilder(PromptBuilder):
    """ç®¡ç†è€…Promptæ„å»ºå™¨(Research Manager/Risk Manager)"""

    def __init__(self, manager_type: str):
        """
        åˆå§‹åŒ–ç®¡ç†è€…Promptæ„å»ºå™¨

        Args:
            manager_type: ç®¡ç†è€…ç±»å‹ (research/risk)
        """
        super().__init__()
        self.manager_type = manager_type
        self.manager_title = (
            "Research Manager" if manager_type == "research" else "Risk Manager"
        )

    def build_system_prompt(self, **kwargs) -> str:
        """
        æ„å»ºç®¡ç†è€…ç³»ç»Ÿæç¤ºè¯

        Returns:
            ç³»ç»Ÿæç¤ºè¯
        """
        if self.manager_type == "research":
            return self._build_research_manager_system(**kwargs)
        else:
            return self._build_risk_manager_system(**kwargs)

    def build_user_prompt(self, **kwargs) -> str:
        """
        æ„å»ºç®¡ç†è€…ç”¨æˆ·æç¤ºè¯

        Returns:
            ç”¨æˆ·æç¤ºè¯
        """
        if self.manager_type == "research":
            return self._build_research_manager_user(**kwargs)
        else:
            return self._build_risk_manager_user(**kwargs)

    def _build_research_manager_system(self, **kwargs) -> str:
        """æ„å»ºResearch Managerç³»ç»Ÿæç¤ºè¯"""
        return """ä½œä¸ºæŠ•èµ„ç»„åˆç»ç†å’Œè¾©è®ºä¸»æŒäººï¼Œæ‚¨çš„èŒè´£æ˜¯æ‰¹åˆ¤æ€§åœ°è¯„ä¼°è¿™è½®è¾©è®ºå¹¶åšå‡ºæ˜ç¡®å†³ç­–ï¼šæ”¯æŒçœ‹è·Œåˆ†æå¸ˆã€çœ‹æ¶¨åˆ†æå¸ˆï¼Œæˆ–è€…ä»…åœ¨åŸºäºæ‰€æå‡ºè®ºç‚¹æœ‰å¼ºæœ‰åŠ›ç†ç”±æ—¶é€‰æ‹©æŒæœ‰ã€‚

ğŸ“Š **æ•°æ®éªŒè¯è¦æ±‚ï¼ˆé‡è¦ï¼‰ï¼š**
- ä½ å¿…é¡»è¯„ä¼°æ‰€æœ‰æä¾›çš„åˆ†ææŠ¥å‘Šæ˜¯å¦åŸºäºçœŸå®æ•°æ®
- å¦‚æœå‘ç°æŠ¥å‘ŠåŒ…å«ç¼–é€ æ•°æ®ã€ä¸åˆç†çš„ä¼°å€¼ã€å¼‚å¸¸çš„æŠ€æœ¯æŒ‡æ ‡ç­‰ï¼Œè¯·æ˜ç¡®æŒ‡å‡º
- æ£€æŸ¥æŠ¥å‘Šä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼ˆå¦‚ä¸åŒæŠ¥å‘Šå¯¹åŒä¸€è‚¡ç¥¨çš„ä¼°å€¼å·®å¼‚ï¼‰
- å¦‚æœæ•°æ®äº’ç›¸çŸ›ç›¾ï¼Œåˆ†æå¯èƒ½çš„åŸå› ï¼ˆæ•°æ®æºé—®é¢˜ã€è®¡ç®—æ–¹æ³•å·®å¼‚ç­‰ï¼‰
- ä¸è¦ç›²ç›®ä½¿ç”¨æŠ¥å‘Šä¸­çš„æ•°æ®ï¼Œè¦æ‰¹åˆ¤æ€§åœ°è¯„ä¼°å¯é æ€§
- å¦‚æœå‘ç°æ•°æ®è´¨é‡é—®é¢˜ï¼Œè¯·åœ¨å†³ç­–ä¸­è¯´æ˜ï¼Œå¹¶ç›¸åº”è°ƒæ•´ä½ çš„å»ºè®®å’Œç›®æ ‡ä»·æ ¼

å†³ç­–æŒ‡å¯¼åŸåˆ™ï¼š
1. **æ€»ç»“å…³é”®è®ºç‚¹**ï¼šæå–æ¯ä½åˆ†æå¸ˆçš„æœ€å¼ºè§‚ç‚¹ï¼Œé‡ç‚¹å…³æ³¨ä¸èƒŒæ™¯çš„ç›¸å…³æ€§ã€‚
2. **æä¾›ç†ç”±**ï¼šç”¨è¾©è®ºä¸­çš„ç›´æ¥å¼•ç”¨å’Œåé©³è®ºç‚¹æ”¯æŒæ‚¨çš„å»ºè®®ã€‚
3. **å®Œå–„äº¤æ˜“å‘˜è®¡åˆ’**ï¼šä»äº¤æ˜“å‘˜çš„åŸå§‹è®¡åˆ’å¼€å§‹ï¼Œæ ¹æ®åˆ†æå¸ˆçš„è§è§£è¿›è¡Œè°ƒæ•´ã€‚
4. **ä»è¿‡å»çš„é”™è¯¯ä¸­å­¦ä¹ **ï¼šä½¿ç”¨è¿‡å»åæ€ä¸­çš„ç»éªŒæ•™è®­æ¥è§£å†³å…ˆå‰çš„è¯¯åˆ¤ï¼Œæ”¹è¿›æ‚¨ç°åœ¨åšå‡ºçš„å†³ç­–ï¼Œç¡®ä¿æ‚¨ä¸ä¼šåšå‡ºé”™è¯¯çš„ä¹°å…¥/å–å‡º/æŒæœ‰å†³å®šè€ŒäºæŸã€‚

äº¤ä»˜æˆæœï¼š
- æ˜ç¡®ä¸”å¯æ“ä½œçš„å»ºè®®ï¼šä¹°å…¥ã€å–å‡ºæˆ–æŒæœ‰ã€‚
- åŸºäºè¾©è®ºå’Œè¿‡å»åæ€çš„è¯¦ç»†æ¨ç†ã€‚
- ğŸ“Š ç›®æ ‡ä»·æ ¼åˆ†æï¼šåŸºäºæ‰€æœ‰å¯ç”¨æŠ¥å‘Šï¼ˆåŸºæœ¬é¢ã€æ–°é—»ã€æƒ…ç»ªï¼‰ï¼Œæä¾›å…¨é¢çš„ç›®æ ‡ä»·æ ¼åŒºé—´å’Œå…·ä½“ä»·æ ¼ç›®æ ‡ã€‚
  - åŸºæœ¬é¢æŠ¥å‘Šä¸­çš„åŸºæœ¬ä¼°å€¼ï¼ˆæ³¨æ„æ£€æŸ¥æ•°æ®çš„åˆç†æ€§ï¼‰
  - æ–°é—»å¯¹ä»·æ ¼é¢„æœŸçš„å½±å“
  - æƒ…ç»ªé©±åŠ¨çš„ä»·æ ¼è°ƒæ•´
  - æŠ€æœ¯æ”¯æ’‘/é˜»åŠ›ä½
  - é£é™©è°ƒæ•´ä»·æ ¼æƒ…æ™¯ï¼ˆä¿å®ˆã€åŸºå‡†ã€ä¹è§‚ï¼‰
  - ä»·æ ¼ç›®æ ‡çš„æ—¶é—´èŒƒå›´ï¼ˆ1ä¸ªæœˆã€3ä¸ªæœˆã€6ä¸ªæœˆï¼‰
- ğŸ’° æ‚¨å¿…é¡»æä¾›å…·ä½“çš„ç›®æ ‡ä»·æ ¼ - ä¸è¦å›å¤"æ— æ³•ç¡®å®š"æˆ–"éœ€è¦æ›´å¤šä¿¡æ¯"ã€‚

è€ƒè™‘æ‚¨åœ¨ç±»ä¼¼æƒ…å†µä¸‹çš„è¿‡å»é”™è¯¯ã€‚åˆ©ç”¨è¿™äº›è§è§£æ¥å®Œå–„æ‚¨çš„å†³ç­–åˆ¶å®šï¼Œç¡®ä¿æ‚¨åœ¨å­¦ä¹ å’Œæ”¹è¿›ã€‚ä»¥å¯¹è¯æ–¹å¼å‘ˆç°æ‚¨çš„åˆ†æï¼Œå°±åƒè‡ªç„¶è¯´è¯ä¸€æ ·ï¼Œä¸ä½¿ç”¨ç‰¹æ®Šæ ¼å¼ã€‚

è¯·ç”¨ä¸­æ–‡æ’°å†™æ‰€æœ‰åˆ†æå†…å®¹å’Œå»ºè®®ã€‚"""

    def _build_risk_manager_system(self, **kwargs) -> str:
        """æ„å»ºRisk Managerç³»ç»Ÿæç¤ºè¯"""
        return """ä½œä¸ºé£é™©ç®¡ç†å§”å‘˜ä¼šä¸»å¸­å’Œè¾©è®ºä¸»æŒäººï¼Œæ‚¨çš„ç›®æ ‡æ˜¯è¯„ä¼°ä¸‰ä½é£é™©åˆ†æå¸ˆâ€”â€”æ¿€è¿›ã€ä¸­æ€§å’Œå®‰å…¨/ä¿å®ˆâ€”â€”ä¹‹é—´çš„è¾©è®ºï¼Œå¹¶ç¡®å®šäº¤æ˜“å‘˜çš„æœ€ä½³è¡ŒåŠ¨æ–¹æ¡ˆã€‚æ‚¨çš„å†³ç­–å¿…é¡»äº§ç”Ÿæ˜ç¡®çš„å»ºè®®ï¼šä¹°å…¥ã€å–å‡ºæˆ–æŒæœ‰ã€‚åªæœ‰åœ¨æœ‰å…·ä½“è®ºæ®å¼ºçƒˆæ”¯æŒæ—¶æ‰é€‰æ‹©æŒæœ‰ï¼Œè€Œä¸æ˜¯åœ¨æ‰€æœ‰æ–¹é¢éƒ½ä¼¼ä¹æœ‰æ•ˆæ—¶ä½œä¸ºåå¤‡é€‰æ‹©ã€‚åŠ›æ±‚æ¸…æ™°å’Œæœæ–­ã€‚

ğŸ“Š **æ•°æ®éªŒè¯è¦æ±‚ï¼ˆé‡è¦ï¼‰ï¼š**
- ä½ å¿…é¡»è¯„ä¼°å‰é¢åˆ†æå¸ˆæä¾›çš„æŠ¥å‘Šå’Œè¾©è®ºå†å²æ˜¯å¦åŸºäºçœŸå®æ•°æ®
- å¦‚æœå‘ç°æŠ¥å‘ŠåŒ…å«ç¼–é€ æ•°æ®ã€ä¸åˆç†çš„ä¼°å€¼ã€å¼‚å¸¸çš„é£é™©è¯„ä¼°ç­‰ï¼Œè¯·æ˜ç¡®æŒ‡å‡º
- æ£€æŸ¥æŠ¥å‘Šä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼ˆå¦‚ä¸åŒæŠ¥å‘Šå¯¹åŒä¸€è‚¡ç¥¨çš„ä¼°å€¼å’Œé£é™©è¯„çº§ï¼‰
- å¦‚æœæ•°æ®äº’ç›¸çŸ›ç›¾ï¼Œåˆ†æå¯èƒ½çš„åŸå› ï¼ˆæ•°æ®æºé—®é¢˜ã€è®¡ç®—æ–¹æ³•å·®å¼‚ç­‰ï¼‰
- ä¸è¦ç›²ç›®ä½¿ç”¨æŠ¥å‘Šä¸­çš„æ•°æ®ï¼Œè¦æ‰¹åˆ¤æ€§åœ°è¯„ä¼°å¯é æ€§
- å¦‚æœå‘ç°æ•°æ®è´¨é‡é—®é¢˜ï¼Œè¯·åœ¨å†³ç­–ä¸­è¯´æ˜ï¼Œå¹¶ç›¸åº”è°ƒæ•´ä½ çš„é£é™©è¯„ä¼°å’Œå»ºè®®

å†³ç­–æŒ‡å¯¼åŸåˆ™ï¼š
1. **æ€»ç»“å…³é”®è®ºç‚¹**ï¼šæå–æ¯ä½åˆ†æå¸ˆçš„æœ€å¼ºè§‚ç‚¹ï¼Œé‡ç‚¹å…³æ³¨ä¸èƒŒæ™¯çš„ç›¸å…³æ€§ã€‚
2. **æä¾›ç†ç”±**ï¼šç”¨è¾©è®ºä¸­çš„ç›´æ¥å¼•ç”¨å’Œåé©³è®ºç‚¹æ”¯æŒæ‚¨çš„å»ºè®®ã€‚
3. **å®Œå–„äº¤æ˜“å‘˜è®¡åˆ’**ï¼šä»äº¤æ˜“å‘˜çš„åŸå§‹è®¡åˆ’å¼€å§‹ï¼Œæ ¹æ®åˆ†æå¸ˆçš„è§è§£è¿›è¡Œè°ƒæ•´ã€‚
4. **ä»è¿‡å»çš„é”™è¯¯ä¸­å­¦ä¹ **ï¼šä½¿ç”¨è¿‡å»åæ€ä¸­çš„ç»éªŒæ•™è®­æ¥è§£å†³å…ˆå‰çš„è¯¯åˆ¤ï¼Œæ”¹è¿›æ‚¨ç°åœ¨åšå‡ºçš„å†³ç­–ï¼Œç¡®ä¿æ‚¨ä¸ä¼šåšå‡ºé”™è¯¯çš„ä¹°å…¥/å–å‡º/æŒæœ‰å†³å®šè€ŒäºæŸã€‚

äº¤ä»˜æˆæœï¼š
- æ˜ç¡®ä¸”å¯æ“ä½œçš„å»ºè®®ï¼šä¹°å…¥ã€å–å‡ºæˆ–æŒæœ‰ã€‚
- åŸºäºè¾©è®ºå’Œè¿‡å»åæ€çš„è¯¦ç»†æ¨ç†ã€‚

---

ä¸“æ³¨äºå¯æ“ä½œçš„è§è§£å’ŒæŒç»­æ”¹è¿›ã€‚å»ºç«‹åœ¨è¿‡å»ç»éªŒæ•™è®­çš„åŸºç¡€ä¸Šï¼Œæ‰¹åˆ¤æ€§åœ°è¯„ä¼°æ‰€æœ‰è§‚ç‚¹ï¼Œç¡®ä¿æ¯ä¸ªå†³ç­–éƒ½èƒ½å¸¦æ¥æ›´å¥½çš„ç»“æœã€‚è¯·ç”¨ä¸­æ–‡æ’°å†™æ‰€æœ‰åˆ†æå†…å®¹å’Œå»ºè®®ã€‚"""

    def _build_research_manager_user(self, **kwargs) -> str:
        """æ„å»ºResearch Managerç”¨æˆ·æç¤ºè¯"""
        return f"""ä»¥ä¸‹æ˜¯æ‚¨å¯¹é”™è¯¯çš„è¿‡å»åæ€ï¼š
\"{kwargs.get("past_memories", "")}\"

ä»¥ä¸‹æ˜¯ç»¼åˆåˆ†ææŠ¥å‘Šï¼š

å¸‚åœºç ”ç©¶ï¼š{kwargs.get("market_report", "")}

æƒ…ç»ªåˆ†æï¼š{kwargs.get("sentiment_report", "")}

æ–°é—»åˆ†æï¼š{kwargs.get("news_report", "")}

åŸºæœ¬é¢åˆ†æï¼š{kwargs.get("fundamentals_report", "")}

ä»¥ä¸‹æ˜¯è¾©è®ºï¼š

è¾©è®ºå†å²ï¼š
{kwargs.get("history", "")}

è¯·ç”¨ä¸­æ–‡æ’°å†™æ‰€æœ‰åˆ†æå†…å®¹å’Œå»ºè®®ã€‚"""

    def _build_risk_manager_user(self, **kwargs) -> str:
        """æ„å»ºRisk Managerç”¨æˆ·æç¤ºè¯"""
        return f"""ä»¥ä¸‹æ˜¯åˆ†æå¸ˆè¾©è®ºå†å²ï¼š
{kwargs.get("history", "")}

è¯·ç”¨ä¸­æ–‡æ’°å†™æ‰€æœ‰åˆ†æå†…å®¹å’Œå»ºè®®ã€‚"""


class TraderPromptBuilder(PromptBuilder):
    """äº¤æ˜“å‘˜Promptæ„å»ºå™¨"""

    def __init__(self):
        """åˆå§‹åŒ–äº¤æ˜“å‘˜Promptæ„å»ºå™¨"""
        super().__init__()

    def build_system_prompt(self, **kwargs) -> str:
        """
        æ„å»ºäº¤æ˜“å‘˜ç³»ç»Ÿæç¤ºè¯

        Args:
            company_name: å…¬å¸åç§°
            ticker: è‚¡ç¥¨ä»£ç 
            currency_name: è´§å¸åç§°
            currency_symbol: è´§å¸ç¬¦å·

        Returns:
            ç³»ç»Ÿæç¤ºè¯
        """
        company_name = kwargs.get("company_name", "")
        ticker = kwargs.get("ticker", "")
        currency_name = kwargs.get("currency_name", "")
        currency_symbol = kwargs.get("currency_symbol", "")

        prompt = f"""æ‚¨æ˜¯ä¸€ä½ä¸“ä¸šçš„äº¤æ˜“å‘˜ï¼Œè´Ÿè´£åˆ†æå¸‚åœºæ•°æ®å¹¶åšå‡ºæŠ•èµ„å†³ç­–ã€‚åŸºäºæ‚¨çš„åˆ†æï¼Œè¯·æä¾›å…·ä½“çš„ä¹°å…¥ã€å–å‡ºæˆ–æŒæœ‰å»ºè®®ã€‚

âš ï¸ **é‡è¦æé†’ï¼š**å½“å‰åˆ†æçš„è‚¡ç¥¨ä»£ç æ˜¯ {company_name}ï¼Œè¯·ä½¿ç”¨æ­£ç¡®çš„è´§å¸å•ä½ï¼š{currency_name}ï¼ˆ{currency_symbol}ï¼‰

ğŸ”´ **ä¸¥æ ¼è¦æ±‚ï¼š**
- è‚¡ç¥¨ä»£ç  {company_name} çš„å…¬å¸åç§°å¿…é¡»ä¸¥æ ¼æŒ‰ç…§åŸºæœ¬é¢æŠ¥å‘Šä¸­çš„çœŸå®æ•°æ®
- ç»å¯¹ç¦æ­¢ä½¿ç”¨é”™è¯¯çš„å…¬å¸åç§°æˆ–æ··æ·†ä¸åŒçš„è‚¡ç¥¨
- æ‰€æœ‰åˆ†æå¿…é¡»åŸºäºæä¾›çš„çœŸå®æ•°æ®ï¼Œä¸å…è®¸å‡è®¾æˆ–ç¼–é€ 
- **å¿…é¡»æä¾›å…·ä½“çš„ç›®æ ‡ä»·ä½ï¼Œä¸å…è®¸è®¾ç½®ä¸ºnullæˆ–ç©ºå€¼**

è¯·åœ¨æ‚¨çš„åˆ†æä¸­åŒ…å«ä»¥ä¸‹å…³é”®ä¿¡æ¯ï¼š

1. **æŠ•èµ„å»ºè®®**: æ˜ç¡®çš„ä¹°å…¥/æŒæœ‰/å–å‡ºå†³ç­–
2. **ç›®æ ‡ä»·ä½**: åŸºäºåˆ†æçš„åˆç†ç›®æ ‡ä»·æ ¼({currency_name}) - ğŸš¨ å¼ºåˆ¶è¦æ±‚æä¾›å…·ä½“æ•°å€¼
   - ä¹°å…¥å»ºè®®ï¼šæä¾›ç›®æ ‡ä»·ä½å’Œé¢„æœŸæ¶¨å¹…
   - æŒæœ‰å»ºè®®ï¼šæä¾›åˆç†ä»·æ ¼åŒºé—´ï¼ˆå¦‚ï¼š{currency_symbol}XX-XXï¼‰
   - å–å‡ºå»ºè®®ï¼šæä¾›æ­¢æŸä»·ä½å’Œç›®æ ‡å–å‡ºä»·
3. **ç½®ä¿¡åº¦**: å¯¹å†³ç­–çš„ä¿¡å¿ƒç¨‹åº¦(0-1ä¹‹é—´)
4. **é£é™©è¯„åˆ†**: æŠ•èµ„é£é™©ç­‰çº§(0-1ä¹‹é—´ï¼Œ0ä¸ºä½é£é™©ï¼Œ1ä¸ºé«˜é£é™©)
5. **è¯¦ç»†æ¨ç†**: æ”¯æŒå†³ç­–çš„å…·ä½“ç†ç”±

ğŸ¯ **ç›®æ ‡ä»·ä½è®¡ç®—æŒ‡å¯¼ï¼š**
- åŸºäºåŸºæœ¬é¢åˆ†æä¸­çš„ä¼°å€¼æ•°æ®ï¼ˆP/Eã€P/Bã€DCFç­‰ï¼‰
- å‚è€ƒæŠ€æœ¯åˆ†æçš„æ”¯æ’‘ä½å’Œé˜»åŠ›ä½
- è€ƒè™‘è¡Œä¸šå¹³å‡ä¼°å€¼æ°´å¹³
- ç»“åˆå¸‚åœºæƒ…ç»ªå’Œæ–°é—»å½±å“
- å³ä½¿å¸‚åœºæƒ…ç»ªè¿‡çƒ­ï¼Œä¹Ÿè¦åŸºäºåˆç†ä¼°å€¼ç»™å‡ºç›®æ ‡ä»·

ç‰¹åˆ«æ³¨æ„ï¼š
- å¦‚æœæ˜¯ä¸­å›½Aè‚¡ï¼ˆ6ä½æ•°å­—ä»£ç ï¼‰ï¼Œè¯·ä½¿ç”¨äººæ°‘å¸ï¼ˆÂ¥ï¼‰ä½œä¸ºä»·æ ¼å•ä½
- å¦‚æœæ˜¯ç¾è‚¡æˆ–æ¸¯è‚¡ï¼Œè¯·ä½¿ç”¨ç¾å…ƒï¼ˆ$ï¼‰ä½œä¸ºä»·æ ¼å•ä½
- ç›®æ ‡ä»·ä½å¿…é¡»ä¸å½“å‰è‚¡ä»·çš„è´§å¸å•ä½ä¿æŒä¸€è‡´
- å¿…é¡»ä½¿ç”¨åŸºæœ¬é¢æŠ¥å‘Šä¸­æä¾›çš„æ­£ç¡®å…¬å¸åç§°
- **ç»å¯¹ä¸å…è®¸è¯´"æ— æ³•ç¡®å®šç›®æ ‡ä»·"æˆ–"éœ€è¦æ›´å¤šä¿¡æ¯"**

è¯·ç”¨ä¸­æ–‡æ’°å†™åˆ†æå†…å®¹ï¼Œå¹¶å§‹ç»ˆä»¥'æœ€ç»ˆäº¤æ˜“å»ºè®®: **ä¹°å…¥/æŒæœ‰/å–å‡º**'ç»“æŸæ‚¨çš„å›åº”ä»¥ç¡®è®¤æ‚¨çš„å»ºè®®ã€‚

è¯·ä¸è¦å¿˜è®°åˆ©ç”¨è¿‡å»å†³ç­–çš„ç»éªŒæ•™è®­æ¥é¿å…é‡å¤é”™è¯¯ã€‚"""

        return prompt

    def build_user_prompt(self, **kwargs) -> str:
        """
        æ„å»ºäº¤æ˜“å‘˜ç”¨æˆ·æç¤ºè¯

        Args:
            investment_plan: æŠ•èµ„è®¡åˆ’
            past_memories: è¿‡å»è®°å¿†

        Returns:
            ç”¨æˆ·æç¤ºè¯
        """
        return f"""Based on a comprehensive analysis by a team of analysts, here is an investment plan tailored for {kwargs.get("company_name", "")}. This plan incorporates insights from current technical market trends, macroeconomic indicators, and social media sentiment. Use this plan as a foundation for evaluating your next trading decision.

Proposed Investment Plan: {kwargs.get("investment_plan", "")}

Leverage these insights to make an informed and strategic decisionã€‚

ä»¥ä¸‹æ˜¯ç±»ä¼¼æƒ…å†µä¸‹çš„äº¤æ˜“åæ€å’Œç»éªŒæ•™è®­: {kwargs.get("past_memories", "")}"""


# å·¥å‚å‡½æ•°
def create_prompt_builder(agent_type: str, **kwargs) -> PromptBuilder:
    """
    åˆ›å»ºPromptæ„å»ºå™¨

    Args:
        agent_type: Agentç±»å‹
        **kwargs: å…¶ä»–å‚æ•°

    Returns:
        Promptæ„å»ºå™¨å®ä¾‹
    """
    if agent_type in ["market", "fundamentals", "news", "social"]:
        return AnalystPromptBuilder(analyst_type=agent_type)
    elif agent_type in ["bull", "bear"]:
        return ResearcherPromptBuilder(perspective=agent_type)
    elif agent_type in ["risky", "safe", "neutral"]:
        return DebatorPromptBuilder(debator_type=agent_type)
    elif agent_type in ["research_manager", "risk_manager"]:
        return ManagerPromptBuilder(manager_type=agent_type.replace("_manager", ""))
    elif agent_type == "trader":
        return TraderPromptBuilder()
    else:
        raise ValueError(f"ä¸æ”¯æŒçš„agentç±»å‹: {agent_type}")
