# -*- coding: utf-8 -*-
"""
测试框架配置
为TradingAgents-CN项目添加pytest支持
"""

import pytest
import asyncio
from pathlib import Path

# 项目根目录
PROJECT_ROOT = Path(__file__).parent.parent

# 测试路径
TESTS_DIR = PROJECT_ROOT / "tests"

# 添加项目根目录到Python路径
import sys
sys.path.insert(0, str(PROJECT_ROOT))

# pytest配置
pytest_plugins = [
    'pytest_asyncio',  # 异步测试支持
    'pytest_cov',      # 覆盖率
]

# 异步测试模式
asyncio_mode = 'auto'

# 测试覆盖率配置
[pytest.coverage.run]
source = ['tradingagents', 'app']
omit = [
    '*/tests/*',
    '*/__pycache__/*',
    '*/node_modules/*',
    '*/migrations/*',
]

[pytest.coverage.report]
exclude_lines = [
    'pragma: no cover',
    'def __repr__',
    'raise AssertionError',
    'raise NotImplementedError',
    'if __name__ == .__main__.:',
    'if TYPE_CHECKING:',
    'class .*\\bProtocol\\):',
    '@(abc\\.)?abstractmethod',
]

# 测试发现
python_files = ['test_*.py', '*_test.py']
python_classes = ['Test*']
python_functions = ['test_*']

# 标记
markers = [
    'unit: 单元测试',
    'integration: 集成测试',
    'slow: 慢速测试',
    'requires_auth: 需要认证的测试',
    'requires_db: 需要数据库的测试',
]

# 警告过滤
filterwarnings = [
    'ignore::DeprecationWarning',
    'ignore::PendingDeprecationWarning',
]

# 最小Python版本
minversion = '7.0'

# 测试输出选项
addopts = [
    '-ra',  # 显示所有测试结果摘要
    '--strict-markers',  # 严格标记模式
    '--tb=short',  # 短格式回溯
]
