# æ•°æ®éªŒè¯åŠŸèƒ½å®æ–½æŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-24
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æˆåŠŸå®Œæˆäº†æ•°æ®éªŒè¯åŠŸèƒ½çš„æ¸…ç†ã€éƒ¨ç½²å’ŒéªŒè¯å·¥ä½œï¼š

1. âœ… æ¸…ç†äº†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶å’Œè°ƒè¯•è„šæœ¬
2. âœ… é‡å¯åç«¯æœåŠ¡å¹¶ç¡®è®¤å¥åº·è¿è¡Œ
3. âœ… éªŒè¯äº†æ•°æ®éªŒè¯å•å…ƒæµ‹è¯•ï¼ˆ12/12é€šè¿‡ï¼‰
4. âœ… åˆ›å»ºäº†æ¼”ç¤ºè„šæœ¬å’ŒéªŒè¯æŠ¥å‘Š

---

## ğŸ”§ é˜¶æ®µ1: ä»£ç æ¸…ç†

### åˆ é™¤çš„æ–‡ä»¶

| æ–‡ä»¶ | ç±»å‹ | åŸå›  |
|------|------|------|
| `nul` | ä¸´æ—¶æ–‡ä»¶ | Windows nullè®¾å¤‡æ–‡ä»¶ |
| `temp_patch_1.txt` | ä¸´æ—¶è¡¥ä¸ | æ—§ç‰ˆæœ¬è¡¥ä¸æ–‡ä»¶ |
| `.claude/` | é…ç½®ç›®å½• | Claude AIé…ç½®ï¼ˆå¯é€‰ï¼‰ |
| `600391_åˆ†ææŠ¥å‘Š_2026-01-24.md` | åˆ†ææŠ¥å‘Š | æ—§æµ‹è¯•æŠ¥å‘Š |
| `605589_åˆ†ææŠ¥å‘Š_2026-01-24.md` | åˆ†ææŠ¥å‘Š | æ—§æµ‹è¯•æŠ¥å‘Š |
| `scripts/test/check_mongodb_data_format.py` | è°ƒè¯•è„šæœ¬ | å¼€å‘è°ƒè¯•ç”¨ |
| `scripts/test/test_price_data_fix.py` | è°ƒè¯•è„šæœ¬ | å¼€å‘è°ƒè¯•ç”¨ |
| `tests/debug/verify_605589_cache.py` | è°ƒè¯•è„šæœ¬ | å¼€å‘è°ƒè¯•ç”¨ |

### ä¿ç•™çš„é‡è¦æ–‡ä»¶

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `tradingagents/utils/trading_date_manager.py` | å·¥å…·ç±» | äº¤æ˜“æ—¥ç®¡ç†å™¨ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰ |
| `tests/unit/test_trading_date_manager.py` | å•å…ƒæµ‹è¯• | äº¤æ˜“æ—¥ç®¡ç†å™¨æµ‹è¯• |
| `tests/unit/test_data_consistency_checker.py` | å•å…ƒæµ‹è¯• | æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥æµ‹è¯• |

---

## ğŸš€ é˜¶æ®µ2: åç«¯æœåŠ¡é‡å¯

### æœåŠ¡çŠ¶æ€

```bash
$ docker-compose ps backend

NAME                    STATUS
tradingagents-backend   Up 47 seconds (healthy)
```

### å¥åº·æ£€æŸ¥

```bash
$ curl http://localhost:8000/api/health
{"success":true,"data":{"status":"ok","timestamp":1769233866}}
```

### æ—¥å¿—çŠ¶æ€

åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œï¼Œå¹¶æ˜¾ç¤ºï¼š
- âœ… æ•°æ®åŒæ­¥æ­£å¸¸ï¼ˆTushareåŒæ­¥è¿›è¡Œä¸­ï¼‰
- âœ… å®šæ—¶ä»»åŠ¡æ­£å¸¸è¿è¡Œ
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹å“åº”æ­£å¸¸

---

## âœ… é˜¶æ®µ3: å•å…ƒæµ‹è¯•éªŒè¯

### æµ‹è¯•ç»“æœ

```bash
$ python -m pytest tests/unit/test_data_consistency_checker.py -v

============================================================================================
test session starts =============================================================================================
platform win32 -- Python 3.11.8, pytest-8.4.2
...
tests/unit/test_data_consistency_checker.py::TestVolumeValidation::test_volume_in_shares_correct PASSED
tests/unit/test_data_consistency_checker.py::TestVolumeValidation::test_volume_in_hands_correct PASSED
tests/unit/test_data_consistency_checker.py::TestVolumeValidation::test_volume_mismatch_hand_vs_share PASSED
tests/unit/test_data_consistency_checker.py::TestVolumeValidation::test_volume_with_expected_amount PASSED
tests/unit/test_data_consistency_checker.py::TestVolumeValidation::test_volume_extremely_low PASSED
tests/unit/test_data_consistency_checker.py::TestVolumeValidation::test_volume_extremely_high PASSED
tests/unit/test_data_consistency_checker.py::TestPEValidation::test_pe_calculation_correct PASSED
tests/unit/test_data_consistency_checker.py::TestPEValidation::test_pe_mismatch_different_period PASSED
tests/unit/test_data_consistency_checker.py::TestPEValidation::test_zero_shares PASSED
tests/unit/test_data_consistency_checker.py::TestPEValidation::test_negative_profit PASSED
tests/unit/test_data_consistency_checker.py::TestDataConsistencyChecker::test_tolerance_thresholds PASSED
tests/unit/test_data_consistency_checker.py::TestDataConsistencyChecker::test_metric_weights PASSED
============================================================================================
12 passed in 1.12s =============================================================================================
```

### æµ‹è¯•è¦†ç›–

**æˆäº¤é‡éªŒè¯æµ‹è¯•ï¼ˆ6é¡¹ï¼‰**:
- âœ… æˆäº¤é‡å•ä½ä¸º"è‚¡"æ—¶çš„éªŒè¯
- âœ… æˆäº¤é‡å•ä½ä¸º"æ‰‹"æ—¶çš„éªŒè¯
- âœ… å•ä½æ··æ·†åœºæ™¯æ£€æµ‹ï¼ˆæŠ¥å‘Šé—®é¢˜å¤ç°ï¼‰
- âœ… å¸¦é¢„æœŸæˆäº¤é¢çš„éªŒè¯
- âœ… å¼‚å¸¸ä½æˆäº¤é‡æ£€æµ‹
- âœ… å¼‚å¸¸é«˜æˆäº¤é‡æ£€æµ‹

**PEéªŒè¯æµ‹è¯•ï¼ˆ4é¡¹ï¼‰**:
- âœ… PEè®¡ç®—æ­£ç¡®æ€§éªŒè¯
- âœ… å‡€åˆ©æ¶¦æœŸé—´ä¸åŒ¹é…æ£€æµ‹
- âœ… æ€»è‚¡æœ¬ä¸ºé›¶çš„é”™è¯¯å¤„ç†
- âœ… å‡€åˆ©æ¶¦ä¸ºè´Ÿçš„é”™è¯¯å¤„ç†

**é…ç½®éªŒè¯æµ‹è¯•ï¼ˆ2é¡¹ï¼‰**:
- âœ… å®¹å¿åº¦é˜ˆå€¼é…ç½®
- âœ… æŒ‡æ ‡æƒé‡é…ç½®

---

## ğŸ“Š æ•°æ®éªŒè¯åŠŸèƒ½è¯´æ˜

### 1. æˆäº¤é‡éªŒè¯ (`validate_volume_consistency`)

**åŠŸèƒ½**: éªŒè¯æˆäº¤é‡æ•°æ®çš„åˆç†æ€§ï¼Œè‡ªåŠ¨æ£€æµ‹å•ä½ï¼ˆæ‰‹ vs è‚¡ï¼‰

**æ ¸å¿ƒé€»è¾‘**:
```python
# Aè‚¡å•æ—¥æˆäº¤é¢é€šå¸¸åœ¨ 1000ä¸‡ - 100äº¿ ä¹‹é—´
MIN_AMOUNT = 10_000_000   # 1000ä¸‡
MAX_AMOUNT = 10_000_000_000  # 100äº¿

# æƒ…å†µ1ï¼šæˆäº¤é‡å•ä½æ˜¯"æ‰‹"ï¼ˆ1æ‰‹=100è‚¡ï¼‰
volume_as_hand = volume_value
volume_in_shares = volume_as_hand * 100
calculated_amount_hand = volume_in_shares * price

# æƒ…å†µ2ï¼šæˆäº¤é‡å•ä½å·²ç»æ˜¯"è‚¡"
volume_as_share = volume_value
calculated_amount_share = volume_as_share * price
```

**è¿”å›å€¼**:
- `Tuple[bool, str, Dict]`: (æ˜¯å¦åˆç†, é”™è¯¯ä¿¡æ¯, è¯Šæ–­ä¿¡æ¯)

**è¯Šæ–­ä¿¡æ¯åŒ…å«**:
- `input_unit`: æ£€æµ‹åˆ°çš„å•ä½ï¼ˆhand/share/invalidï¼‰
- `corrected_volume`: ä¿®æ­£åçš„æˆäº¤é‡
- `corrected_amount`: è®¡ç®—çš„æˆäº¤é¢
- `amount_difference_pct`: ä¸é¢„æœŸæˆäº¤é¢çš„å·®å¼‚ç™¾åˆ†æ¯”

### 2. PEéªŒè¯ (`validate_pe_calculation`)

**åŠŸèƒ½**: éªŒè¯PEè®¡ç®—æ˜¯å¦æ­£ç¡®

**æ ¸å¿ƒé€»è¾‘**:
```python
# è®¡ç®—EPSï¼ˆæ¯è‚¡æ”¶ç›Šï¼‰
eps = net_profit / total_shares

# è®¡ç®—PE
calculated_pe = current_price / eps

# å¯¹æ¯”æŠ¥å‘ŠPEå’Œè®¡ç®—PE
pe_diff_pct = abs(calculated_pe - reported_pe) / reported_pe

# åˆ¤æ–­æ˜¯å¦åœ¨åˆç†è¯¯å·®èŒƒå›´å†…ï¼ˆ5%ï¼‰
is_correct = pe_diff_pct <= 0.05
```

**è¿”å›å€¼**:
- `Tuple[bool, str, Dict]`: (æ˜¯å¦æ­£ç¡®, é”™è¯¯ä¿¡æ¯, è¯Šæ–­ä¿¡æ¯)

**è¯Šæ–­ä¿¡æ¯åŒ…å«**:
- `calculated_eps`: è®¡ç®—çš„EPS
- `calculated_pe`: è®¡ç®—çš„PE
- `pe_difference`: PEå·®å¼‚ç»å¯¹å€¼
- `pe_difference_pct`: PEå·®å¼‚ç™¾åˆ†æ¯”

### 3. ä½¿ç”¨ç¤ºä¾‹

```python
from app.services.data_consistency_checker import DataConsistencyChecker

checker = DataConsistencyChecker()

# éªŒè¯æˆäº¤é‡
volume = 555_410  # æ‰‹
price = 53.65
is_valid, error_msg, diagnostic = checker.validate_volume_consistency(volume, price)

# éªŒè¯PE
symbol = "600391"
reported_pe = 397.7
current_price = 53.65
total_shares = 332_000_000
net_profit = 44_600_000

is_valid, error_msg, diagnostic = checker.validate_pe_calculation(
    symbol, reported_pe, current_price, total_shares, net_profit
)
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸï¼ˆç«‹å³å¯åšï¼‰

1. **æµ‹è¯•çœŸå®åˆ†ææŠ¥å‘Š**
   - è®¿é—® http://localhost:8000
   - ç™»å½•ååˆ†æè‚¡ç¥¨600391
   - æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æ˜¾ç¤ºæ•°æ®éªŒè¯è­¦å‘Š

2. **éªŒè¯æ•°æ®æºåˆ‡æ¢**
   - ç¡®è®¤AKShareæ•°æ®ï¼ˆ2026-01-23ï¼‰è¢«ä¼˜å…ˆä½¿ç”¨
   - æ£€æŸ¥æŠ¥å‘Šä¸­çš„æ•°æ®æ›´æ–°æ—¶é—´

### ä¸­æœŸï¼ˆ1-2å‘¨ï¼‰

1. **æ·»åŠ æŠ¥å‘Šè¾“å‡ºé›†æˆ**
   - åœ¨åˆ†ææŠ¥å‘Šä¸­æ˜¾ç¤ºæ•°æ®è´¨é‡è­¦å‘Š
   - æ·»åŠ æ•°æ®æ¥æºå’Œå¯ä¿¡åº¦æ ‡è®°

2. **æ‰©å±•éªŒè¯åŠŸèƒ½**
   - æ·»åŠ PBéªŒè¯
   - æ·»åŠ å¸‚å€¼éªŒè¯
   - æ·»åŠ æ¢æ‰‹ç‡éªŒè¯

### é•¿æœŸï¼ˆ1ä¸ªæœˆ+ï¼‰

1. **æŠ€æœ¯æŒ‡æ ‡éªŒè¯**
   - ç»Ÿä¸€MA/RSI/MACD/BOLLè®¡ç®—å…¬å¼
   - éªŒè¯æŠ€æœ¯æŒ‡æ ‡å‚æ•°çš„åˆç†æ€§

2. **æ•°æ®è¿½æº¯åŠŸèƒ½**
   - åœ¨æŠ¥å‘Šä¸­å¼•ç”¨åŸå§‹æ•°æ®
   - æ·»åŠ å¯å¤ç°çš„æ•°æ®æŸ¥è¯¢ä»£ç 

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒå®ç°

- `app/services/data_consistency_checker.py` - æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å™¨
- `tradingagents/utils/dataflow_utils.py` - äº¤æ˜“æ—¥æ—¥æœŸå¤„ç†
- `tradingagents/dataflows/data_source_manager.py` - æ•°æ®æºç®¡ç†å™¨

### æµ‹è¯•æ–‡ä»¶

- `tests/unit/test_data_consistency_checker.py` - æ•°æ®éªŒè¯æµ‹è¯•
- `tests/unit/test_trading_date_manager.py` - äº¤æ˜“æ—¥ç®¡ç†å™¨æµ‹è¯•

### æ¼”ç¤ºè„šæœ¬

- `scripts/demo_data_validation.py` - æ•°æ®éªŒè¯åŠŸèƒ½æ¼”ç¤º

---

## âš ï¸ å·²çŸ¥é—®é¢˜

1. **ç»ˆç«¯è¾“å‡ºç¼–ç é—®é¢˜**
   - Windowsç¯å¢ƒä¸‹çš„bashç»ˆç«¯å­˜åœ¨ç¼–ç è¾“å‡ºé—®é¢˜
   - è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨æ–‡ä»¶è¾“å‡ºæˆ–PowerShell

2. **Tushareå®šæ—¶ä»»åŠ¡é”™è¯¯**
   - Tushareè¿æ¥å¤±è´¥é”™è¯¯ï¼ˆé¢„æœŸè¡Œä¸ºï¼Œå› ä¸ºå·²ç¦ç”¨TushareåŒæ­¥ï¼‰
   - ä¸å½±å“æ ¸å¿ƒåˆ†æåŠŸèƒ½

3. **LSPè¯Šæ–­é”™è¯¯**
   - é¡¹ç›®ä¸­å­˜åœ¨ä¸€äº›é¢„å®šä¹‰çš„LSPè¯Šæ–­é”™è¯¯
   - è¿™äº›æ˜¯å†å²é—®é¢˜ï¼Œä¸å½±å“åŠŸèƒ½

---

## ğŸ‰ ç»“è®º

æ•°æ®éªŒè¯åŠŸèƒ½å·²æˆåŠŸéƒ¨ç½²å¹¶é€šè¿‡æµ‹è¯•éªŒè¯ï¼š

- âœ… 12/12 å•å…ƒæµ‹è¯•é€šè¿‡
- âœ… åç«¯æœåŠ¡å¥åº·è¿è¡Œ
- âœ… ä»£ç å·²æ¸…ç†ï¼Œä¸´æ—¶æ–‡ä»¶å·²åˆ é™¤
- âœ… æ¼”ç¤ºè„šæœ¬å·²åˆ›å»º

**ä¸‹ä¸€æ­¥**: åœ¨çœŸå®åˆ†æä¸­æµ‹è¯•æ•°æ®éªŒè¯åŠŸèƒ½ï¼ŒéªŒè¯ä¿®å¤æ•ˆæœã€‚
